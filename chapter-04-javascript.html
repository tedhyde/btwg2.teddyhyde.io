<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>JavaScript and the Git Data API</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="JavaScript">JavaScript and the Git Data API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Applications utilizing the GitHub API will typically reside inside a
server. You are not limited, however, to accessing
the API from within server side programming languages exclusively.
The GitHub API works perfectly well from within a web browser context
as well, and the UI to your application come for free if you know a
little HTML. In this chapter we discuss how to use the unofficial
JavaScript client library to access the GitHub API and build a single
page application (SPA) which we host entirely on GitHub.</p>
</div>
<div class="paragraph">
<p>The main weakness of JavaScript has always been testability. Mainly
due to the asynchronous nature of JavaScript, writing tests has never
been easy; polling for changes when a callback returns was until
recently the best way to test nonlinear code. But, recent
toolkits like AngularJS and promise-based libraries have made testing
not only easy but elegant as well. Building applications on top of
third party services makes testing even more important than it already
was, and we&#8217;ll make sure to add testing to our application to verify
the functionality works as we expect.</p>
</div>
<div class="paragraph">
<p>JavaScript should be generally accessible to most people who know other
imperative programming languages. There is one feature, however, that
can be challenging: the callback function. In JavaScript, functions
are first class objects, meaning they can be passed as arguments to
other functions, and stored as the value of a variable. You will find
callbacks everywhere in JavaScript programming. Callbacks make
debugging and understanding JavaScript code more challenging at
times. As we stated earlier, writing code that includes tests makes
understanding the entire picture easier, and we will do that in this
chapter to further explain sections where necessary function callbacks
may initially look confusing.</p>
</div>
<div class="sect2">
<h3 id="_building_a_coffee_shop_database_on_github">Building a Coffee Shop Database on GitHub</h3>
<div class="paragraph">
<p>Like many software developers, I suffer from an almost disturbing
obsession with coffee. Perhaps it is really my family that suffers:
when we travel to a new city, I drag my wife and children through
questionable neighborhoods just to find the perfect brew and
complementary gluten free desserts.</p>
</div>
<div class="paragraph">
<p>Google Maps is a great help on these quests, in that it will find me a
coffee shop and reviews, but the granularity of information about that
coffee shop is often poor and limited in scope. Do they offer rice
milk as a dairy free alternative?  What special details should I know
when considering a place? Many guidance and mapping applications
exist, but if they don&#8217;t fit my own personalized informational niche,
I might miss a unique experience. With such a pressing and dire
problem in front of us, let&#8217;s use the GitHub API to solve it.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll build a coffee shop single page web app which allows anyone to add
information on coffee shops, information which is flexible and
dynamic, and search and filter through that information about a coffee
shop. All files, such as the HTML, images  and JavaScript will be
hosted on GitHub. And, we&#8217;ll be using the GitHub API to allow
contributors to add data to our database, a database which we will
also host on GitHub. And, as GitHub developers write code with tests,
we will write tests to validate our JavaScript code as well as the
expectations we have of the GitHub API.</p>
</div>
<div class="paragraph">
<p>More specifically, we&#8217;ll use these technologies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/michael/github">an (unofficial) GitHub API JavaScript library</a></p>
</li>
<li>
<p><a href="http://angularjs.org">AngularJS</a> a "superpowered framework" for writing JS applications that
are testable.</p>
</li>
<li>
<p><a href="http://getbootstrap.com">Bootstrap</a> a CSS library which simplifies building beautiful webapps</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You don&#8217;t need to know these technologies in advance of working on this chapter.</p>
</div>
</div>
<div class="sect2">
<h3 id="_set_up">Set Up</h3>
<div class="paragraph">
<p>To create our app, let&#8217;s first create our main web page and push it into our repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ mkdir coffeete.ch
$ cd coffeete.ch
$ git init
$ git checkout -b gh-pages
$ printf "&lt;html&gt;\n&lt;body&gt;Hello from CoffeeTe.ch&lt;/body&gt;\n&lt;/html&gt;\n" &gt; index.html
$ git commit -m "Add starting point index.html" -a
$ git config push.default gh-pages</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we created a new repository, and then created and entered
the gh-pages branch. We&#8217;ll do all our work there. And, by using the
git config command, we specified that we want the default push branch
to be gh-pages. This allows us to use <code>git push</code> to push our branch up
instead of the longer <code>git push origin gh-pages</code>.</p>
</div>
<div class="sect3">
<h4 id="_mapping_hostnames">Mapping Hostnames</h4>
<div class="paragraph">
<p>Once we publish these files into GitHub inside a repository we can connect the repository to a
real hostname. There are two steps to take to do this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add a CNAME file which tells GitHub under which server name this service should resolve.</p>
</li>
<li>
<p>Setup DNS records so that the hostname maps to the correct IP
address at GitHub.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Imagine you have the hostname myspecialhostname.com. If you map this
repository to a subdomain called coffeetech, then you would do
something like this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ echo 'coffeetech.myspecialhostname.com' &gt; CNAME
$ git commit -m "Added CNAME mapping" -a
$ git push</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that you need to wait about ten minutes before GitHub
regenerates their database to establish the connection between your
gh-pages site and the mapping on their front end servers. This is only
the first time you connect a repository to a hostname; you will see
subsequent changes almost instantaneously.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Generally it takes several hours to even a few days to propagate DNS
settings out into the wild, so make sure you choose and setup a
hostname far in advance if your site has to be live by a certain point.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now we can install the libraries needed for this application.</p>
</div>
</div>
<div class="sect3">
<h4 id="_adding_the_support_libraries">Adding the support libraries</h4>
<div class="paragraph">
<p>As we mentioned, we will use the GitHub.js library, AngularJS, and
Bootstrap. Let&#8217;s add those to our project now. Using whatever editor
you prefer, edit the index.html file to look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;html&gt;
&lt;head&gt;
&lt;title&gt;CoffeeTe.ch&lt;/title&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt; <b class="conum">(1)</b>
&lt;link rel="stylesheet" type="text/css" href="bootstrap.min.css"&gt;&lt;/link&gt;
&lt;/head&gt;
&lt;body ng-app&gt; <b class="conum">(2)</b>
&lt;div class="container"&gt;
{{'Welcome to Coffeete.ch'}} <b class="conum">(3)</b>
&lt;/div&gt;
&lt;script src="angular.js"&gt;&lt;/script&gt;
&lt;script src="github.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>I am assuming you have a firm grasp on most HTML concepts, but a few
of the advanced topics here:</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>meta</code> tag makes our page work well with mobile browsers and
enables the resposive features of Bootstrap.</p>
</li>
<li>
<p>The <code>ng-app</code> attribute in the body tag tells AngularJS to initialize
and compile our page from the body tag downward.</p>
</li>
<li>
<p>The <code>{{ }}</code> (double brackets) are an AngularJS two-way data binding
directive. You&#8217;ll see two-way data binding in action very soon if it
is not already familiar. Adding this code here sanity checks whether
AngularJS is working for us; if we see "Welcome to Coffeete.ch"
without the braces then we know AngularJS is loading and working
properly. If we see the braces, then there is some error in our
setup to resolve. Two way data-binding solves a significant pain point when building JS apps:
marshalling data back and forth between network events, into HTML
and out of HTML forms. AngularJS does all this heavy lifting for
you. In a moment we&#8217;ll show how to use two-way databinding as it was
intended by defining a variable on the AngularJS scope. We then
access the variable using the same <code>{{ }}</code> databinding directives.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then, download the necessary files locally using these commands. We
include AngularJS, Github.js and Bootstrap CSS</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ wget https://ajax.googleapis.com/ajax/libs/angularjs/1.2.10/angular.js
$ wget https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css
$ wget https://github.com/michael/github/raw/master/github.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to use the GitHub library inside our SPA.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_an_angularjs_application_using_github_js">An AngularJS Application using GitHub.js</h3>
<div class="paragraph">
<p>Now let&#8217;s implement a file <code>coffeetech.js</code> file which is where we will
build our single page application functionality. Create a new file called
<code>coffeetech.js</code> in the root of your repository.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var mod = angular.module( 'coffeetech', [] ) <b class="conum">(1)</b>
mod.controller( 'GithubCtrl', function( $scope ) { <b class="conum">(2)</b>
  var github = new Github({} ); <b class="conum">(3)</b>
  var repo = github.getRepo( "gollum", "gollum" ); <b class="conum">(4)</b>
  repo.show( function(err, repo) { <b class="conum">(5)</b>
    $scope.repo = repo;
    $scope.$apply(); <b class="conum">(6)</b>
  });
})</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Define a module named "coffeetech". Save a reference to the
module which we will use next in defining a controller, a smaller
bundle of functions. Modules are an AngularJS feature for grouping
related functionality, and we will keep all our code for this
application inside this module.</p>
</li>
<li>
<p>We define a controller called <code>GithubCtrl</code> which bundles up
functions and data. When we use the controller syntax, we name the
controller, and then define a function with at least a single
parameter: the scope object. I think of scope as the "world" available
to the controller. The controller knows only of data and functions
defined on its scope, and AngularJS does its magic as long as your
functions or variables are defined on the scope.</p>
</li>
<li>
<p>We create a new <code>Github()</code> object using the constructor. This
constructor can take user credentials, but for now, we can just
create it without those since we are accessing a public repository.</p>
</li>
<li>
<p>Once we have our <code>github</code> object, we call the method <code>getRepo()</code>
with a owner and a name. This returns our repository object.</p>
</li>
<li>
<p>To actually load the data for this repository object, we call the <code>show</code>
method and pass it a callback which uses the two parameters <code>err</code>
and <code>repo</code> to handle errors or otherwise provide us with details of
the repository specified. In this case we are using the Gollum wiki
public repository to display some sample data.</p>
</li>
<li>
<p>Once we have loaded the repository data, we need to call <code>$apply</code>
to tell AngularJS a change has occurred to data stored within the
scope variable. As we mentioned before, AngularJS knows only about
functions and data defined on its scope. The <code>show</code> function is
defined on the GitHub object, so any changes are not tracked by
AngularJS, so we need to use <code>$apply()</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Github.js handles making the proper request to Github for us, and
AngularJS handles putting the results into our web page. To modify our
HTML to use this data, we change <code>index.html</code> to look like the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;html&gt;
&lt;head&gt;
&lt;title&gt;CoffeeTe.ch&lt;/title&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
&lt;link rel="stylesheet" type="text/css" href="bootstrap.min.css"&gt;&lt;/link&gt;
&lt;/head&gt;
&lt;body ng-app="coffeetech"&gt; <b class="conum">(1)</b>
&lt;div class="container" ng-controller="GithubCtrl"&gt;
{{ repo }} <b class="conum">(2)</b>
&lt;/div&gt;
&lt;script src="angular.js"&gt;&lt;/script&gt;
&lt;script src="github.js"&gt;&lt;/script&gt;
&lt;script src="coffeetech.js"&gt;&lt;/script&gt; <b class="conum">(3)</b>
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Change the <code>ng-app</code> reference to use the module we
defined in our <code>coffeetech.js</code> file.</p>
</li>
<li>
<p>Remove our databinding to the <code>Welcome to CoffeeTech</code> string
and replace it with a binding to the variable <code>repo</code> (by default
AngularJS will filter complex objects and convert them to JSON).</p>
</li>
<li>
<p>Add a reference to our <code>coffeetech.js</code> file beneath our other JS
references.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you load this up in your browser, you will see something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-gollum.png" alt="The Whole Messy JSON">
</div>
<div class="title">Figure 1. The Whole Messy JSON</div>
</div>
<div class="paragraph">
<p>That is a lot of data. AngularJS&#8217;s JSON filter pretty printed
it for us, but this is a bit too much. Let&#8217;s change the HTML to reduce
some noise.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;html&gt;
&lt;head&gt;
&lt;title&gt;CoffeeTe.ch&lt;/title&gt;
&lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
&lt;link rel="stylesheet" type="text/css" href="bootstrap.min.css"&gt;&lt;/link&gt;
&lt;/head&gt;
&lt;body ng-app="coffeetech"&gt;
&lt;div class="container" ng-controller="GithubCtrl"&gt;
&lt;div&gt;Subscriber count: {{ repo.subscribers_count }}&lt;/div&gt; <b class="conum">(1)</b>
&lt;div&gt;Network count: {{ repo.network_count }}&lt;/div&gt; <b class="conum">(2)</b>
&lt;/div&gt;
&lt;script
src="angular.js"&gt;&lt;/script&gt;
&lt;script src="github.js"&gt;&lt;/script&gt;
&lt;script src="coffeetech.js"&gt;&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can filter this information by modifying the HTML to show just a
few vital pieces of information from the repository JSON. Let&#8217;s
display the <code>subscriber_count</code> and the <code>network_count</code>. Now we see
something more palatable.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-gollum-precise.png" alt="Pulling Out What We Want">
</div>
<div class="title">Figure 2. Pulling Out What We Want</div>
</div>
<div class="paragraph">
<p>We&#8217;ve just extracted the subscriber and network count from the gollum
repository hosted on GitHub using the GitHub API and placed it into
our single page app.</p>
</div>
<div class="sect3">
<h4 id="_visualize_application_data_structure">Visualize Application Data Structure</h4>
<div class="paragraph">
<p>We are going to be building a coffeeshop database. We want to use Git
as our datastore, but Git and its associated tools (either command
line tools or GitHub) don&#8217;t offer the same features as
a standard relational database. So, we need to think and plan how we
will structure our data inside our repository to make it easily searchable.</p>
</div>
<div class="paragraph">
<p>This application allows us to search coffee shops. These coffee shops
will be, for the most part, in larger cities. If we keep all the data
stored as JSON files named after the city, we can keep data located in
a file named after the city, and then either use geolocation on the
client side to retrieve a set of the data, or ask the user to choose
their city manually.</p>
</div>
<div class="paragraph">
<p>If we look at the <a href="https://github.com/michael/github">Github.js javascript documentation on Github</a>
we can see that there are some
options for us to pull content from a repository. We&#8217;ll store a data
file in JSON named after the city inside our repository and retrieve
this from that repository. It looks like the calls we need to use are
<code>github.getRepo( username, reponame )</code> and once we have retrieved the
repository, <code>repo.contents( branch, path, callback )</code>.</p>
</div>
<div class="paragraph">
<p>Now that we have a bare bones application let&#8217;s pause and make sure we
are building something we can refactor and maintain long term. This
means adding tests to our project.</p>
</div>
</div>
<div class="sect3">
<h4 id="_making_our_app_testable">Making our App Testable</h4>
<div class="paragraph">
<p>Testing not only builds better code by making us think
clearly about how our code will be used from the outside, but makes it
easier for an outsider (meaning other team members) to use our code.
Testing facilitates "social coding."</p>
</div>
<div class="paragraph">
<p>We&#8217;ll use a JavaScript testing tool called "karma". Karma simplifies
writing JavaScript unit tests. We need to first install the tool, then
write a test or two. Karma can easily be installed using NPM
(installation of which is documented in the <a href="#appendix">[appendix]</a>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ npm install karma -g
$ wget https://ajax.googleapis.com/ajax/libs/angularjs/1.2.7/angular-mocks.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>angular-mocks.js</code> file makes it easy to mock out Angular
dependencies in our tests.</p>
</div>
<div class="paragraph">
<p>Then, create a file called <code>karma.config.js</code> and enter the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">module.exports = function(config) {
  config.set({
    basePath: '',
    frameworks: ['jasmine'],
    files: [
        'angular.js',
        'fixtures-*.js',
        'angular-mocks.js',
        'firebase-mock.js',
        'github.js',
        '*.js'
    ],
    reporters: ['progress'],
    port: 9876,
    colors: true,
    logLevel: config.LOG_INFO,
    autoWatch: true,
    browsers: ['Chrome'],
    captureTimeout: 60000,
    singleRun: false
  });
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is more or less a default Karma configuration file.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>files</code> section specifying the load order of our JavaScript
implementations and the test scripts. You can see a few of the files we&#8217;ve
added above specified directly and wildcards to cover the remaining
files.</p>
</li>
<li>
<p>Note also that we&#8217;ve specified Chrome as our test browser (so
you should have it installed), which is a safe bet because it works on
just about any desktop platform you might be running. Know that
you can always choose Safari or Firefox if you want Karma to test
inside those as well. Karma will start a new instance of each browser
specified and run your tests inside a test harness in those browsers.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>To write the test, let&#8217;s clarify what we want our code to do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When a user first visits the application, we should use the
geolocation features of their browser to determine their location.</p>
</li>
<li>
<p>Pull a file from our repository which contains general latitude and
longitude locations of different cities.</p>
</li>
<li>
<p>Iterate over the list of cities and see if we are within 25 miles of
any of the cities. If so, set the current city to the first match.</p>
</li>
<li>
<p>If we found a city, load the JSON data file from GitHub</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Concretely, let&#8217;s assert that we load the list of cities and have 2
of them, then we load a matching city named "Portland", a city which
has three shops available.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll use a <code>ng-init</code> directive which is the mechanism to tell
AngularJS we want to call the function specified when the controller
has finished loading. We&#8217;ll call this function <code>init</code> so let&#8217;s test it
below.</p>
</div>
<div class="paragraph">
<p>First, we will write the setup code for an AngularJS test written
using the Jasmine test framework. Jasmine is a "Behavior-Driven
JavaScript" library which provides functions to group and create
expectation based tests. Within the Jasmine framework are "matchers"
which allow for the most common assertions (comparing a variety of
expected types to the resultant types from function calls) and the
ability to define your own custom matchers. Jasmine also gives you the
ability to "spy" on functions, which is another way of saying Jasmine
can intercept function calls to validate that those calls were made in
the way you anticipate. It is easiest to explain the power of Jasmine
by showing the elegance of the tests themselves, so let&#8217;s do that now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">describe( "GithubCtrl", function() {
    var scope = undefined; <b class="conum">(1)</b>
    var ctrl = undefined;
    var gh  = undefined;
    var repo = undefined;
    var geo = undefined;

    beforeEach( module( "coffeetech" ) ); <b class="conum">(2)</b>

    beforeEach( inject( function ($controller, $rootScope ) { <b class="conum">(3)</b>
            generateMockGeolocationSupport(); <b class="conum">(4)</b>
            generateMockRepositorySupport();
            scope = $rootScope.$new(); <b class="conum">(5)</b>
            ctrl = $controller( "GithubCtrl",
	       { $scope: scope, Github: gh, Geo: geo } ); <b class="conum">(6)</b>
        } )
    );
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We declare our variables at the top of the function. If we did not
do this, JavaScript would silently define them inside the functions
the first time the variable is used. Then our variables would be
different inside our setup code and the actual tests.</p>
</li>
<li>
<p>We load our <code>coffeetech</code> module into our tests using the <code>module</code>
method inside a <code>beforeEach</code> call, code which is executed before our
tests run.</p>
</li>
<li>
<p><code>inject</code> is the AngularJS way to provide our before functions with
the <code>$controller</code> and <code>$rootScope</code> objects, which we use to setup our tests.</p>
</li>
<li>
<p>We will be creating two functions which generate the mock objects
required for our tests. We&#8217;ll discuss these two functions in a bit.</p>
</li>
<li>
<p>Scope is the angular convention for the object into which all
functionality and state is stored. We create a new scope using the
AngularJS utility function <code>$rootScope.$new()</code> function and store a
reference to this scope so we can test functionality we&#8217;ve implemented
in our actual code.</p>
</li>
<li>
<p>We pass in the mocked objects (created by the mocked function
calls) as well as the scope object and instantiate a controller
object. This controller uses the scope to define functions and data,
and since we have a reference to it, we can call those functions and
inspect that data and assert our implementation is correct.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now, let&#8217;s write an actual test.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">    describe( "#init", function() { <b class="conum">(1)</b>
        it( "should initialize, grabbing current city", function() { <b class="conum">(2)</b>
            scope.init(); <b class="conum">(3)</b>
            expect( geo.getCurrentPosition ).toHaveBeenCalled(); <b class="conum">(4)</b>
            expect( gh.getRepo ).toHaveBeenCalled();
            expect( repo.read ).toHaveBeenCalled();
            expect( scope.cities.length ).toEqual( 2 ); <b class="conum">(5)</b>
            expect( scope.city.name ).toEqual( "portland" );
            expect( scope.shops.length ).toEqual( 3 );
        });
    });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Describe functions are used to group tests defined inside <code>it</code>
functions. Since we are testing the <code>init</code> function, it seems logical
to use an identifier called <code>#init</code>.</p>
</li>
<li>
<p><code>describe</code> blocks group tests while <code>it</code> blocks actually specify
code which is run as a test.</p>
</li>
<li>
<p>Our controller code begins with an <code>init</code> call, so we mimic that
inside our test to setup the controller state.</p>
</li>
<li>
<p>We assert that our code uses the various interfaces we defined on
our injected objects: <code>getCurrentPosition</code> on the Geo object, and <code>read</code>
on the repository object.</p>
</li>
<li>
<p>Then we assert the data is properly loaded. Our test verifies that
there are two cities, that a default city has been loaded and the name
of the default city is equal to the string "Portland". In addition,
the test verifies there are three shops loaded for the default
city. Behind the scenes in our implementation we will load these via
JSON, but all we care about is that the interface and data matches our
expectations.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This syntax initially can look confusing if you have never written
Jasmine tests for JavaScript, but it actually solves a lot of problems
in an elegant way. Most importantly, Jasmine provides a <code>spyOn</code>
function that will intercept a call to it, and then allow you to
assert that it was called. Any place in our tests you see
<code>toHaveBeenCalled()</code> is an assertion that <code>spyOn</code> provides to us
proving that a call was made.</p>
</div>
<div class="paragraph">
<p>Now we can implement the two mocking functions vital for the test. Put
them in between the <code>beforeEach( module( "coffeetech" ) )</code> line and
the <code>beforeEach( inject( &#8230;&#8203; ) )</code> functions to provide proper
visibility to Karma.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...
beforeEach( module( "coffeetech" ) );

function generateMockGeolocationSupport( lat, lng ) { <b class="conum">(1)</b>
    response = ( lat &amp;&amp; lng ) ?
        { coords: { lat: lat, lng: lng } } :
	{ coords: CITIES[0] };
    geo = { getCurrentPosition: function( success, failure ) { <b class="conum">(2)</b>
        success( response );
    } };
    spyOn( geo, "getCurrentPosition" ).andCallThrough(); <b class="conum">(3)</b>
}

function generateMockRepositorySupport() { <b class="conum">(4)</b>
    repo = { read: function( branch, filename, cb ) { <b class="conum">(5)</b>
        cb( undefined,
	    JSON.stringify( filename == "cities.json" ?
	    		    CITIES : PORTLAND ) );
    } };
    spyOn( repo, "read" ).andCallThrough();

    gh = new Github({});
    spyOn( gh, "getRepo" ).andCallFake( function() { <b class="conum">(6)</b>
        return repo;
    } );
}

beforeEach( inject( function ($controller, $rootScope ) {
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We first implement the <code>generateMockLocation</code> function.</p>
</li>
<li>
<p>Mock location involves creating a Geo object which has a single
function <code>getCurrentPosition</code> which is a function that calls back into
a success callback function provided. This exactly matches the native
browser support for Geolocation which has the same function defined.</p>
</li>
<li>
<p>We then <code>spyOn</code> the function so we can assert that it was called
in our actual tests.</p>
</li>
<li>
<p>Next we implement <code>generateMockRepositorySupport</code>.</p>
</li>
<li>
<p>Again we implement a mock object: this one to provide a method called
<code>read</code>. This function matches the function of the same name contained
in the API provided by the JavaScript GitHub.js library. Just like in
the previous mock, we <code>spyOn</code> the function so we can validate it was
called. However, this is not the "top level" repository object, this
is the object returned from the call to <code>getRepo</code>. We will take this
mock object and return it from the <code>getRepo</code> call.</p>
</li>
<li>
<p>We spy on the <code>getRepo</code> call, and then return our next mock
object, the repository object. This object is used to retrieve the
actual information using the <code>read</code> call.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now that we have a set of tests, run the test suite from the command
line and watch them fail.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ karma start karma.conf.js
Chrome 32.0.1700 (Mac OS X 10.9.1) GithubCtrl #init should initialize,
          grabbing current city FAILED
	Error: [$injector:modulerr] Failed to instantiate module coffeetech due to:
	Error: [$injector:nomod] Module 'coffeetech' is not available!
	  You either misspelled the module name or forgot to load it.
	  If registering a module ensure that you specify the
	  dependencies as the second argument.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We now need to provide some test fixtures.</p>
</div>
</div>
<div class="sect3">
<h4 id="_test_data">Test Data</h4>
<div class="paragraph">
<p>We need to build our support fixtures, data files which have test data. Add the
<code>fixtures-cities.js</code> file into the same directory as your other code.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var CITIES = [{
    name: "portland",
    latitude: 45,
    longitude: 45
}, {
    name: "seattle",
    latitude: 47.662613,
    longitude: -122.323837
}]</code></pre>
</div>
</div>
<div class="paragraph">
<p>And, the <code>fixtures-portland.js</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var PORTLAND = [{
    "name": "Very Good Coffee Shop",
    "latitude": 45.52292,
    "longitude": -122.643074
}, {
    "name": "Very Bad Coffee Shop",
    "latitude": 45.522181,
    "longitude": -122.63709
}, {
    "name": "Mediocre Coffee Shop",
    "latitude": 45.520437,
    "longitude": -122.67846
}]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_coffeetech_js">CoffeeTech.js</h4>
<div class="paragraph">
<p>Then, add the <code>coffeetech.js</code> file. We&#8217;ll focus just on the setup code
and the changes to the <code>init</code> function for now.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var mod = angular.module( 'coffeetech', [] );

mod.factory( 'Github', function() {  // <b class="conum">(1)</b>
    return new Github({});
});

mod.factory( 'Geo', [ '$window', function( $window ) {  // <b class="conum">(2)</b>
    return $window.navigator.geolocation;
} ] );

mod.factory( 'Prompt', [ '$window', function( $window ) {
    return $window.prompt;
} ] );

mod.controller( 'GithubCtrl', [ '$scope', 'Github', 'Geo', 'Prompt',  // <b class="conum">(3)</b>
    		function( $scope, ghs, Geo, Prompt ) {
    $scope.messages = []

    $scope.init = function() { // <b class="conum">(4)</b>
        $scope.getCurrentLocation( function( position ) {
            $scope.latitude = position.coords.latitude;
            $scope.longitude = position.coords.longitude;
            $scope.repo = ghs.getRepo( "xrd", "spa.coffeete.ch" );  // <b class="conum">(5)</b>
            $scope.repo.read( "gh-pages", "cities.json", function(err, data) {  // <b class="conum">(6)</b>
                $scope.cities = JSON.parse( data );  // <b class="conum">(7)</b>
                // Determine our current city
                $scope.detectCurrentCity();  // <b class="conum">(8)</b>

                // If we have a city, get it
                if( $scope.city ) {
                    $scope.retrieveCity();
                }

                $scope.$apply(); // <b class="conum">(9)</b>
            });
        });
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We extract the Github library into an AngularJS factory. This
allows us to inject our mocked GitHub object inside our tests; if we
had placed the GitHub instance creation code inside our controller,
we would not have been able to easily mock it out in our tests.</p>
</li>
<li>
<p>We extract the geolocation support into an AngularJS factory. As
we did with the GitHub library mock, we can now inject a fake one into
our tests.</p>
</li>
<li>
<p>Our new controller "injects" the various objects we need. We have
extracted the GitHub API object and a Geo object into dependencies,
and this syntax finds the proper objects and provides them to our
controller. You&#8217;ll also notice a slightly different syntax for
creating the controller <code>controller( "CtrlName", [ 'dependency1',
'dependency2', function( dependency1, dependency2 ) {} ] );</code>. This
style works even if JavaScript minification were to occur; the
previous incarnation we saw would not have survived this process
because AngularJS would not have known the dependency name after
it had been mangled by a minimizer.</p>
</li>
<li>
<p>We extract the functionality into a function called <code>init</code> which
we can explicitly call from within our tests.</p>
</li>
<li>
<p>Set the username and load the repository. If you are putting this into
your own repository, modify this appropriately, but you can use these
arguments until you do post this into your own repository.</p>
</li>
<li>
<p>We use the <code>read</code> method to pull file contents from the
repository. Notice we use the <code>gh-pages</code> branch since we are storing our
single page app and all the data there.</p>
</li>
<li>
<p>Once our data is returned to us, it is simply a string. We need to
reconstitute this data to a JavaScript object using the <code>JSON.parse</code> method.</p>
</li>
<li>
<p>After we retrieve our data from the repository, we can use the
data inside the cities array to determine our current city.</p>
</li>
<li>
<p>Since we are calling outside of AngularJS and returning inside a
callback, we need to call <code>scope.$apply()</code> like we showed in prior examples.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We are now ready to write our Geocoding implementation.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_geocoding_support">Geocoding Support</h3>
<div class="paragraph">
<p>We&#8217;ll build functions
to retrieve the data for a city from the GitHub API, find the location
of the user using their browser&#8217;s Geolocation feature, use the user&#8217;s
current location to determine what cities they are close to, implement
a distance calculation function, load the city once close proximity
cities are determined, and finally, add a function to query the user
for their GitHub credentials and annotation data.</p>
</div>
<div class="paragraph">
<p>First, we can implement the city loading functions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">$scope.retrieveCity = function() {
    $scope.repo.read( "gh-pages", $scope.city.name + ".json", function(err, data) {
        $scope.shops = JSON.parse( data );
        $scope.$apply();
    });
}

$scope.getCurrentLocation = function( cb ) {
    if( undefined != Geo ) {
        Geo.getCurrentPosition( cb, $scope.geolocationError );
    } else {
        console.error('not supported');
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>retrieveCity</code> retrieves a list of shops in the same way that we
retrieved the list of cities by reading from the repository
object. After loading the data into the scope, we need to call
<code>$apply()</code> to notify Angular.</p>
</li>
<li>
<p><code>loadCity</code> uses the city name to load city data.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Next we can implement the functionality to calculate distances between the current user and available cities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">};

$scope.detectCurrentCity = function() {
    // Calculate the distance from our current position and use
    // this to determine which city we are closest to and within
    // 25 miles
    for( var i = 0; i &lt; $scope.cities.length; i++ ) {
        var dist = $scope.calculateDistance( $scope.latitude, $scope.longitude, $scope.cities[i].latitude, $scope.cities[i].longitude );
        if( dist &lt; 25 ) {
            $scope.city = $scope.cities[i];
            break;
        }
    }
}

toRad = function(Value) {
    return Value * Math.PI / 180;
};

$scope.calculateDistance = function( latitude1, longitude1, latitude2, longitude2 ) {
    R = 6371;
    dLatitude = toRad(latitude2 - latitude1);
    dLongitude = toRad(longitude2 - longitude1);
    latitude1 = toRad(latitude1);
    latitude2 = toRad(latitude2);
    a = Math.sin(dLatitude / 2) * Math.sin(dLatitude / 2) + Math.sin(dLongitude / 2) * Math.sin(dLongitude / 2) * Math.cos(latitude1) * Math.cos(latitude2);
    c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    d = R * c;
    return d;
}

$scope.loadCity = function( city ) {
    $scope.repo.read( "gh-pages", city + ".json", function(err, data) {
        $scope.shops = JSON.parse( data );
        $scope.$apply();
    });
}

$scope.geolocationError = function( error ) {
    console.log( "Inside failure" );
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We build a <code>getCurrentLocation</code> funtion which we will call within
our code. We use the injected <code>Geo</code> object which has our
<code>getCurrentPosition</code> function (which inside our tests will be the
mocked function, and inside our real code just layers an abstraction
on top of the native browser interface).</p>
</li>
<li>
<p>We need to provide an error callback to the <code>getCurrentPosition</code>
call, so we implement that, which does logs it to the console.</p>
</li>
<li>
<p>Then we build <code>detectCurrentCity</code>, which will look over the list
of cities and see if we are in one.</p>
</li>
<li>
<p>We iterate over the list of cities and calculate whether they are
within 25 miles of our current location. Each city is stored with its
own latitude and longitude data. When we find a city, we store that in
the scope as the official current city and exit the loop.</p>
</li>
<li>
<p>To calculate distance, we need to build a radian conversion
function.</p>
</li>
<li>
<p>Finally, we build our distance calculation function.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>At first glance, the calculate distance function looks confusing, no?
This was code I developed after reading a post on Geocoding using a
stored procedure within the PostgreSQL database, and I converted the
code to JavaScript. Unless you are a geocoding geek, how do we know
this works as advertised? Well, let&#8217;s write some tests to prove it.
Add these lines to the bottom of your <code>coffeetech.spec.js</code>, just within
the last <code>});</code> closing braces:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">    describe( "#calculateDistance", function() {
        it( "should find distance between two points", function() {
            expect( parseInt(
	        scope.calculateDistance( 14.599512,
					 120.98422,
					 10.315699,
					 123.885437 ) * 0.61371 ) ).
			toEqual( 354 );
        });
    });</code></pre>
</div>
</div>
<div class="paragraph">
<p>To build this test, I searched for "distance between Manila" and
Google autocompleted my search to "Cebu". It says they are 338 miles
apart. I then grabbed latitude and longitudes for those cities and
built the test above. I expected my test to fail as my coordinates
were going to be off by a few miles here or there. But, the test
showed that our distance was 571. Hmm, perhaps we calculated in kilometers, not miles?
Indeed, I had forgotten this algorithm actually calculated the
distance in kilometers, not miles. So, we need to multiply the result
by 0.621371 to get the value in miles, which ends up being close
enough to what Google reports the distance to be.</p>
</div>
<div class="sect3">
<h4 id="_city_data">City Data</h4>
<div class="paragraph">
<p>Let&#8217;s seed our application with some starting data and write out the
<code>cities.json</code> file.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">[
  {
    "longitude": -122.67620699999999,
    "latitude": 45.523452,
    "name": "portland"
  },
  {
    "longitude": -122.323837,
    "latitude": 47.662613,
    "name": "seattle"
  }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now that we have our geocoding implementation complete and sample data
in place, we can move on to acquiring credentials from the user.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_login">Adding Login</h3>
<div class="paragraph">
<p>If we want people to fork a repository on GitHub, we need to have them
login to GitHub. So, we need to ask for credentials.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...

$scope.annotate = function() {
    user = Prompt( "Enter your github username" )
    password = Prompt( "Enter your github password" )
    data = Prompt( "Enter data to add" );
};

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now expose the new data inside the <code>index.html</code> file like so
(omitting the obvious from the HTML):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;body ng-app="coffeetech"&gt;

&lt;div class="container" ng-controller="GithubCtrl" ng-init="init()"&gt;

&lt;h1&gt;CoffeeTe.ch&lt;/h1&gt;

&lt;h3 ng-show="city"&gt;Current city: {{city.name}}&lt;/h3&gt;

&lt;div class="row"&gt;
&lt;div class="col-md-6"&gt;&lt;h4&gt;Shop Name&lt;/h4&gt; &lt;/div&gt;
&lt;div class="col-md-6"&gt;&lt;h4&gt;Lat/Lng&lt;/h4&gt; &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row" ng-repeat="shop in shops"&gt; <b class="conum">(1)</b>
&lt;div class="col-md-6"&gt;   <b class="conum">(2)</b>
{{ shop.name }}  <b class="conum">(3)</b>
&lt;/div&gt;
&lt;div class="col-md-6"&gt; {{ shop.latitude }} / {{ shop.longitude }} &lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>ng-repeat</code> is an AngularJS directive which iterates over an array
of items. Here we use it to iterate over the items in our
<code>portland.json</code> file and insert a snippet of HTML with our data
interpolated from each item in the iteration.</p>
</li>
<li>
<p>Bootstrap makes it easy to establish structure in our HTML. The
<code>col-md-6</code> class tells Bootstrap to build a column sized at 50% of our 12
column layout (the default for Bootstrap layouts). We setup two
adjacent columns this way. And, if we are inside a mobile device, it
properly stacks these columns.</p>
</li>
<li>
<p>Using AngularJS two way databinding, we insert the name of the
shop.</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_errors_already">Errors Already?</h4>
<div class="paragraph">
<p>If you run this in your browser, you will not see the shops for our city
displayed. Something is broken, so
let&#8217;s investigate. I recommend using the Chrome browser to
debug this, but you can use any browser and set of developer tools you
like. For Chrome, right clicking on the
page anywhere and selecting "Inspect Element" at the bottom (or by
the keyboard shortcut "F12" or "Ctrl + Shift
+ I" on Windows or Linux or "Cmd + Opt + I" on Mac ) will bring up
the developer console. Then select the
console window. Refresh the browser window, and you&#8217;ll see this in the
console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-error" data-lang="error">Uncaught TypeError: Cannot call method 'select' of undefined</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you click on the link to the right for github.js, you&#8217;ll see this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-underscore-missing.png" alt="An Unexpected Error">
</div>
<div class="title">Figure 3. An Unexpected Error</div>
</div>
<div class="paragraph">
<p>You see at the point of error that we are calling <code>select</code> on the tree.
Select appears to be a method defined on an underscore character. If
you use JavaScript frequently, you&#8217;ll recognize that the underscore
variable comes from the Underscore library, and <code>select</code> is a method
which detects the first matching instance inside an array. Under the
hood, the Github.js library is pulling the entire tree from the
repository, then iterating over each item in the tree, then selecting
the item from the tree which matches the name of the file we have
requested. This is an important performance implication to consider;
the GitHub API does not provide a way to directly request content by
the path name. Instead, you pull a list of files and then request the
file by the SHA hash, a two step process that makes two (potentially
lengthy) calls to the API.</p>
</div>
<div class="paragraph">
<p>How do we fix the error telling us <code>select</code> is undefined? Did we forget
to include underscore.js? Reviewing the documentation on Github.js, we
see that it states underscore.js and base64.js are required. We forgot
to include them. Oops! To include these, run these commands from the
console:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ wget http://underscorejs.org/underscore-min.js
$ wget https://raw.github.com/dankogai/js-base64/master/base64.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, add the libraries to your <code>index.html</code> so that the JavaScript
includes look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html index.html" data-lang="html index.html">...

&lt;script src="angular.js"&gt;&lt;/script&gt;
&lt;script src="underscore-min.js"&gt;&lt;/script&gt;
&lt;script src="base64.min.js"&gt;&lt;/script&gt;
&lt;script src="github.js"&gt;&lt;/script&gt;
&lt;script src="coffeetech.js"&gt;&lt;/script&gt;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can build out some faked data and start envisioning the
structure of our data that will eventually come from our users.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_displaying_soon_to_be_user_reported_data">Displaying (Soon-To-Be) User Reported Data</h3>
<div class="paragraph">
<p>So far we have built a database of cities and coffee shops in those
cities. Google Maps or Apple Maps already provide this information.
If we layer additional information on top of this data (like quirky
information about the coffeeshop), however, then we might have something that
someone might find useful once they have found the coffeeshop on their
favorite mapping application.</p>
</div>
<div class="paragraph">
<p>So, to start, let&#8217;s add some faked data to our coffee shop
information. Add a file called <code>portland.json</code> file that looks like
this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html index.html" data-lang="html index.html">[
   {
      "information" : [
         "offers gluten free desserts",
         "free wifi",
         "accepts dogs"
      ],
      "longitude" : -122.643074,
      "latitude" : 45.52292,
      "name" : "Very Good Coffee Shop"
   },
   {
      "latitude" : 45.522181,
      "name" : "Very Bad Coffee Shop",
      "longitude" : -122.63709
   },
   {
      "name" : "Mediocre Coffee Shop",
      "latitude" : 45.520437,
      "longitude" : -122.67846
   }
]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we added an array called <code>information</code> to our data set.
We&#8217;ll use this to allow simple search. Add the search feature to our
<code>index.html</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">...

&lt;div class="container" ng-controller="GithubCtrl" ng-init="init()"&gt;

&lt;h1&gt;CoffeeTe.ch&lt;/h1&gt;

&lt;input style="width: 20em;" ng-model="search" placeholder="Enter search parameters..."/&gt; <b class="conum">(1)</b>

&lt;h3 ng-show="city"&gt;Current city: {{city.name}}&lt;/h3&gt;

&lt;div class="row="&gt;
&lt;div class="col-md-6"&gt;&lt;h4&gt;Shop Name&lt;/h4&gt; &lt;/div&gt;
&lt;div class="col-md-6"&gt;&lt;h4&gt;Lat/Lng&lt;/h4&gt; &lt;/div&gt;
&lt;/div&gt;
&lt;div class="row" ng-repeat="shop in shops | filter:search"&gt; <b class="conum">(2)</b>
&lt;div class="col-md-6"&gt;
{{ shop.name }}

&lt;div ng-show="search"&gt; <b class="conum">(3)</b>
&lt;span ng-repeat="info in city.information"&gt;
&lt;span class="label label-default"&gt;city.data&lt;/span&gt;
&lt;/span&gt;
&lt;/div&gt;

&lt;/div&gt;
&lt;div class="col-md-6"&gt;
&lt;a target="_map" <b class="conum">(4)</b>
   href="http://maps.google.com/?q={{shop.latitude}},{{shop.longitude}}"&gt;
   Open in map ({{shop.latitude}},{{shop.longitude}})
&lt;/a&gt;
&lt;/div&gt;
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We add a search box which binds to the <code>search</code> model in our scope</p>
</li>
<li>
<p>We add a filter on the data to display which searches through all
data inside each item in our <code>shops</code> array.</p>
</li>
<li>
<p>If we are searching (the model variable <code>search</code> is defined) then
we show the extra information.</p>
</li>
<li>
<p>We alter our lat/lng information to point to a Google Maps page.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now if we type in the word <code>gluten</code> in our search box, we filter out
anything except shops which match that, and we see the information
pieces formatted as labels underneath the shop name.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-search-box.png" alt="Filtering coffeeshops using the term gluten">
</div>
<div class="title">Figure 4. Filtering coffeeshops using the term gluten</div>
</div>
<div class="sect3">
<h4 id="_user_contributed_data">User Contributed Data</h4>
<div class="paragraph">
<p>Now that we have a functioning application, let&#8217;s allow people to add
information themselves and help build our database. Just beneath the
link to the map link, add a button which will allow us to annotate a
coffeeshop with extra information.</p>
</div>
<div class="paragraph">
<p>To make a contribution, users will fork the repository, make a change,
and then issue a pull-request from the fork to the original
repository. Forking means we create a copy of the original repository
in our GitHub account. All these steps are
possible from within our webapp using the Github.js library. Of
course, if someone is going to fork a repository into their account,
we must ask the user to login, so we will prompt them for
their username and password. If you are grimacing at the thought of a
webapp asking for GitHub credentials, don&#8217;t fret, we&#8217;ll find a safe
way to achieve the same thing shortly.</p>
</div>
<div class="paragraph">
<p>The implementation we will use starts with adding an "annotate" button
to our HTML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;button ng-click="annotate(shop)"&gt;Add factoid&lt;/button&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s add some tests. Add another file called
<code>coffeetech.annotate.spec.js</code> with these contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">describe( "GithubCtrl", function() {

    var scope = undefined, gh = undefined, repo = undefined, prompter = undefined;

    function generateMockPrompt() {
        prompter = { prompt: function() { return "ABC" } }; <b class="conum">(1)</b>
        spyOn( prompter, "prompt" ).andCallThrough();

    }

    var PR_ID = 12345;
    function generateMockRepositorySupport() { <b class="conum">(2)</b>
        repo = {
            fork: function( cb ) {
                cb( false );
            },
            write: function( branch, filename, data, commit_msg, cb ) {
                cb( false );
            },
            createPullRequest: function( pull, cb ) {
                cb( false, PR_ID );
            },
            read: function( branch, filename, cb ) {
                cb( undefined, JSON.stringify( filename == "cities.json" ? CITIES : PORTLAND ) );
            }
        };
        spyOn( repo, "fork" ).andCallThrough();
        spyOn( repo, "write" ).andCallThrough();
        spyOn( repo, "createPullRequest" ).andCallThrough();
        spyOn( repo, "read" ).andCallThrough();

        gh = { getRepo: function() {} }; <b class="conum">(3)</b>
        spyOn( gh, "getRepo" ).andCallFake( function() {
            return repo;
        } );
        ghs = { create: function() { return gh; } };
    }

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>It looks similar to our previous tests where we mock out a bunch of
items from the Github.js library.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We added a mock prompt. We will be prompting the user for
username, password and the annotating data, and we will use the native
browser prompt mechanism to do this.</p>
</li>
<li>
<p>We added three new methods to our mock Github object: <code>fork</code>,
<code>write</code> and <code>createPullRequest</code>. We test that these are called.</p>
</li>
<li>
<p>When we call the <code>getRepo</code> function we want to spy on it so we can
assure it is called, but we also want to return the fake repository we
provide inside our test, and this syntax does that.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We have some setup code which is called in a before function to load
the mock objects and establish a controller and scope for testing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...

var $timeout;  // <b class="conum">(1)</b>
beforeEach( inject( function ($controller, $rootScope, $injector ) {
    generateMockRepositorySupport();  // <b class="conum">(2)</b>
    generateMockPrompt();
    $timeout = $injector.get( '$timeout' );  // <b class="conum">(3)</b>
    scope = $rootScope.$new();
    ctrl = $controller( "GithubCtrl",
	     { $scope: scope,
	       Github: ghs,
	       '$timeout': $timeout,
	       '$window': prompter } );
} ) );
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>According to the documentation for <code>fork</code> in the Github.js
library, this method can take a little time to return (as long as it
takes for GitHub to complete our fork request, which is
nondeterministic), so we need to set a timeout in our app and query
for the new repository. If we are using AngularJS, we can ask it for a
mocked and programmatic timeout interface which we can control inside
our tests.</p>
</li>
<li>
<p>We generate our mocked GitHub method calls and spies, and we
follow that by mocking our prompt calls.</p>
</li>
<li>
<p>As mentioned above, we need to get <code>$timeout</code>, and we can use the
injector to retrieve the mocked one AngularJS provides for testing using this call.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...
describe( "#annotate", function() {  <b class="conum">(1)</b>
    it( "should annotate a shop", function() {
        scope.city = PORTLAND
        var shop = { name: "A coffeeshop" }
        scope.annotate( shop ); <b class="conum">(2)</b>
        expect( scope.shopToAnnotate ).toBeTruthy();<b class="conum">(3)</b>
        expect( prompter.prompt.calls.length ).toEqual( 3 );
        expect( scope.username ).not.toBeFalsy();
        expect( scope.annotation ).not.toBeFalsy();

        expect( repo.fork ).toHaveBeenCalled(); <b class="conum">(4)</b>
        expect( scope.waiting.state ).toEqual( "forking" ); <b class="conum">(5)</b>
        $timeout.flush();<b class="conum">(6)</b>

        expect( scope.forkedRepo ).toBeTruthy(); <b class="conum">(7)</b>
        expect( repo.read ).toHaveBeenCalled();
        expect( repo.write ).toHaveBeenCalled();
        expect( repo.createPullRequest ).toHaveBeenCalled();
        expect( scope.waiting.state ).toEqual( "annotated" );
        $timeout.flush();<b class="conum">(8)</b>

        expect( scope.waiting ).toBeFalsy();
    });

});
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We create a new describe block to organize our tests, calling it
<code>#annotate</code>. We then implement one <code>it</code> function which is the single
test we are creating: "annotate a shop."</p>
</li>
<li>
<p>After setting up the preconditions that our scope object should
have a city selected, and creating a shop to annotate, We then call
our <code>annotate</code> method.</p>
</li>
<li>
<p>Once we have called <code>annotate</code>, our code should request our
credentials for the GitHub API, and then ask us for the information
to use in annotating the shop. If this were happening in the browser,
we would get three prompts. Our test mocks out the <code>prompt</code> object
here, and we should therefore see three calls made to our mocked prompt object. We also
validate some state we should see on the scope object like holding a
username and annotation for usage later.</p>
</li>
<li>
<p>We should then see the first of our GitHub API calls being made:
GitHub.js should issue a request to <code>fork</code> the repository.</p>
</li>
<li>
<p>We should then enter in our waiting state; we will tell the user
we are waiting and our UI will use the scope <code>waiting.state</code> to notify
them of that.</p>
</li>
<li>
<p>Once we have flushed the timeout which simulates completion of the
fork, we will then see our code storing the result of the forked repo
into the scope.</p>
</li>
<li>
<p>Next we can observe the other GitHub API calls which perform the annotation.</p>
</li>
<li>
<p>We flush again to resolve the timeouts, and then finally, after
everything is done, we should no longer be telling the user they are
in a waiting state.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>If you are still running karma in the background, you&#8217;ll see the tests
fail with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Chrome 32.0.1700 (Mac OS X 10.9.1) GithubCtrl #annotate should
annotate a shop FAILED
         TypeError: Object #&lt;Scope&gt; has no method 'annotate'
             at null.&lt;anonymous&gt; (/.../coffeetech.spec.js:80:19)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s implement this functionality in our <code>coffeetech.js</code> file.
Add these lines to the bottom of the file, but before the last closing
braces. The function <code>annotate</code> actually does two things: make a fork of the
repository for the user, and then adds annotation information to that
repository using the GitHub API once the fork has completed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...
$scope.annotate = function( shop ) { <b class="conum">(1)</b>
    $scope.shopToAnnotate = shop;
    $scope.username = $window.prompt( "Enter your github username (not email!)" )
    pass = $window.prompt( "Enter your github password" )
    $scope.annotation = $window.prompt( "Enter data to add" ); <b class="conum">(2)</b>
    gh = ghs.create( $scope.username, pass );  <b class="conum">(3)</b>
    toFork = gh.getRepo( "xrd", "spa.coffeete.ch" ); <b class="conum">(4)</b>
    toFork.fork( function( err ) {
        if( !err ) { <b class="conum">(5)</b>
            $scope.notifyWaiting( "forking", "Forking in progress on GitHub, please wait" );<b class="conum">(6)</b>
            $timeout( $scope.annotateAfterForkCompletes, 10000 );<b class="conum">(7)</b>
            $scope.$apply();
        }
    } );

};
  ...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We start by creating our annotation function. As we specified in
our tests, this function takes a shop object, an object into which
annotations about the shop are added.</p>
</li>
<li>
<p>We prompt the user three times: username and password on GitHub,
and the text they want to annotate. If this seems like a really bad
way to do things, don&#8217;t worry, we&#8217;ll fix it in a moment.</p>
</li>
<li>
<p>We create a new Github object with the username and password
provided. We leave it as an exercise of the reader to contend with
mistyped or incorrect credentials.</p>
</li>
<li>
<p>The GitHub.js library allows you to create a repository object
(meaning create a local reference to an existing repository) using the
<code>getRepo</code> function. Once we have this, we can issue a <code>fork</code> to the
repository.</p>
</li>
<li>
<p>If we did not get an error, we still need to contend with the fact
that forking takes a non-determinstic amount of time. So, we schedule
a timeout in 10 seconds which will check to make sure our request
completed. As this operation is happening inside the browser, we have
no way of registering for a notification, and as such, must poll
GitHub to determine whether our fork has completed. In the real world,
we probably would need to redo this request if we see it fail as this
could just mean it was still pending on GitHub.</p>
</li>
<li>
<p>We register a message using a key called "forking" which we can
use inside our HTML template to display to the user that our fork has
completed. We&#8217;ll build this function out soon, and it basically stores
the value and a string for display, and allows us to clear it when the
message is no longer valid.</p>
</li>
<li>
<p>Finally, we call a method <code>annotateAfterForkCompletes</code> which adds
data to our new forked repository once the process is fully complete.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s now build the code to annotate our repository after the fork has
completed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...

$scope.annotateAfterForkCompletes = function() {<b class="conum">(1)</b>
    $scope.forkedRepo = gh.getRepo( $scope.username, "spa.coffeete.ch" );
    $scope.forkedRepo.read( "gh-pages", "cities.json", function(err, data) {
        if( err ) {
            $timeout( $scope.annotateAfterForkCompletes, 10000 );
        }
        else {
            $scope.notifyWaiting( "annotating", "Annotating data on GitHub" ); <b class="conum">(2)</b>
            // Write the new data into our repository
            $scope.appendQuirkToShop();

            var newData = JSON.stringify( $scope.shops, stripHashKey, 2 ); <b class="conum">(3)</b>
            $scope.forkedRepo.write('gh-pages', $scope.city.name + '.json', <b class="conum">(4)</b>
                                    newData,
                                    'Added my quirky information',
                                    function(err) {
                if( !err ) {
                    // Annotate our data using a pull request
                    var pull = { <b class="conum">(5)</b>
                        title: "Adding quirky information to " + $scope.shopToAnnotate.name,
                        body: "Created by :" + $scope.username,
                        base: "gh-pages",
                        head: $scope.username + ":" + "gh-pages"
                    };
                    target = gh.getRepo( "xrd", "spa.coffeete.ch" ); <b class="conum">(6)</b>
                    target.createPullRequest( pull, function( err, pullRequest ) { <b class="conum">(7)</b>
                        if( !err ) {
                            $scope.notifyWaiting( "annotated", "Successfully sent annotation request" );<b class="conum">(8)</b>
                            $timeout( function() { $scope.notifyWaiting( undefined ) }, 5000 );
                            $scope.$apply(); <b class="conum">(9)</b>
                        }
                    } );
                }
                $scope.$apply();
            });
        }
        $scope.$apply();
    } );

...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Once we have verified the fork has completed, we need to get the
new forked repository. We use the username provided to our code when
the user logs in to build the repository object. We then read the
<code>cities.json</code> file from the repository; if we retrieve this file
successfully (we don&#8217;t see the <code>err</code> object evaluating to true) then
we know we are ready to start editing data.</p>
</li>
<li>
<p>We notify the UI that we are annotating and tell the user they
will need to wait while the annotation request is in progress.</p>
</li>
<li>
<p><code>JSON.stringify</code> converts our annotated shop object into a JSON
object. If you have used JSON.stringify before, you might not know
about the other two parameters (beyond just the object you want to
serialize) you can provide to this function. These
two extra parameters allow us to filter the object and specify certain
elements to ignore when serializing and how and if to indent the
resultant JSON. So, we provide the stripHashKey function to remove the
<code>$$hashKey</code> Angular tracking data, and an indentation count. The
indentation count makes it much easier to read a pull request, because
the diff&#8217;ing algorithm can diff line by line rather than as a long
JSON string, which is how <code>JSON.stringify</code> serializes by default.</p>
</li>
<li>
<p>We then write data back to the forked repository using the <code>write</code>
function. If this succeeds, the error value will be undefined inside
the callback function as the last parameter.</p>
</li>
<li>
<p>If our error was undefied, we are in a position where we can make
a pull request back to the original repository. To make a pull
request, we create a pull request object which we
need to provide to the pull request method inside of GitHub.js.</p>
</li>
<li>
<p>We then get a reference to the target of the pull request, the
original repository.</p>
</li>
<li>
<p>We then issue the pull request against the target. This takes the pull request
specification object we created earlier, and a callback function which
has an error code if the request failed, and otherwise, a pull request
object.</p>
</li>
<li>
<p>Once the request has succeeded, we can notify the UI that the
annotation process has completed, and then issue a timeout to remove
that from the UI after 5000 milliseconds, or 5 seconds.</p>
</li>
<li>
<p>Any time we are inside a callback in a third part library (like
GitHub.js) we, as mentioned before, need to use <code>$apply()</code> to notify
Angular that our scope object has changed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We have three convenience methods to implement.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...

$scope.appendQuirkToShop = function() { <b class="conum">(1)</b>
    if( undefined == $scope.shopToAnnotate.information ) {
        $scope.shopToAnnotate.information = [];
    }
    $scope.shopToAnnotate.information.push( $scope.annotation );
};

function stripHashKey( key, value ) { <b class="conum">(2)</b>
    if( key == "$$hashKey" ) {
        return undefined;
    }
    return value;
}

$scope.notifyWaiting = function( state, msg ) { <b class="conum">(3)</b>
    if( state ) {
        $scope.waiting = {};
        $scope.waiting.state = state;
        $scope.waiting.msg = msg;
    }
    else {
        $scope.waiting = undefined;
    }
}
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The <code>appendQuirkToShop</code> function creates an empty array if it is
not yet defined and then adds the annotation to the list of annotations
We don&#8217;t want our code to crash if we try to add an
annotation to an object for which there is an undefined array reference.</p>
</li>
<li>
<p>We define a transformation function which we used with the
<code>JSON.stringify</code> function above. AngularJS adds a tracking attribute
(<code>$$hashKey</code>) to our objects when we use the <code>ng-repeat</code> directive and
this function filters out that so that our pull request data is clean.</p>
</li>
<li>
<p><code>notifyWaiting</code> (obviously) notifies users. We create a waiting
object, and then update the state (which our app will use to hide or
display messages) and then a message itself. If we provide an empty
message, we will clear the object, effectively removing the message from the UI.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Now we need to expose the status message in our UI by modifying the
HTML.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">...
&lt;input class="ctinput" ng-model="search" placeholder="Enter search parameters..."/&gt; <b class="conum">(1)</b>

&lt;h3 ng-show="city"&gt;Current city: {{city.name}}&lt;/h3&gt;

&lt;div ng-show="waiting"&gt;
{{waiting.msg}}
&lt;/div&gt;
...</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_accepting_pull_requests">Accepting Pull Requests</h3>
<div class="paragraph">
<p>When someone makes an annotation to a shop, the owner of the original repository
gets a pull request notification on GitHub.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-pull-request.png" alt="Adding information through a pull request">
</div>
<div class="title">Figure 5. Adding information through a pull request</div>
</div>
<div class="paragraph">
<p>Now we can review changes through GitHub&#8217;s integrated online diff tool.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-pull-request-diff.png" alt="Reviewing annotation pull request diff's from within GitHub">
</div>
<div class="title">Figure 6. Reviewing annotation pull request diff&#8217;s from within GitHub</div>
</div>
<div class="paragraph">
<p>Here we  see a clear "diff" of the changes our contributor
made: they added an annotation that tells us "no turtles allowed". We
might want to consider a different location the next time we have a
date with Morla. The diff is clear in that the green information is
easy to read, which is a benefit we get when we use the
<code>JSON.stringify</code> function with the third parameter set to something
other than undefined. Unfortunately, the first line differs only by the
extra comma but this is still a very readable diff.</p>
</div>
</div>
<div class="sect2">
<h3 id="_towards_a_safe_login_implementation">Towards a Safe Login Implementation</h3>
<div class="paragraph">
<p>If I saw this app in the wild I would never use it to submit data. The
app asks for my GitHub username and password. Asking for my username
and password implicitly asks me to trust the authors of this
application. Trust in this case means that I trust them to not
maliciously use my credentials for nefarious purposes, and also asks
me to trust that they are not doing something stupid which would allow
an attacker to insert themselves into the middle of the
authentication process and steal my crendentials. GitHub is a large
part of my online identity and I would never provide these
crendentials to a web application.</p>
</div>
<div class="paragraph">
<p>Fortunately, we have an alternative to asking for passwords: OAuth.</p>
</div>
<div class="paragraph">
<p>When we use OAuth, our users enter their credentials directly into
GitHub. If our users have turned on 2-factor authentication, GitHub
can still authenticate them (while our naive implementation could not
be modified to accept this type of authentication process). Once we
have entered our credentials, GitHub decides whether we
are who we say we are, and then returns us to the application which
requested access.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
There are many benefits to using OAuth. GitHub provides the
application with what is called an OAuth token that encapsulates
exactly what services on GitHub we have access to, and
whether that access is read-only or whether we can add data in a
read-write manner. This means our requesting service can ask to modify
only parts of our data within GitHub; this provides a much higher
level of trust to users as they know the application cannot touch the
more private parts within GitHub. Specifically, this means we could
ask for access only to gists and not request access to our
repositories. One important point about OAuth tokens is that they can
be revoked. So, once a specific action has been taken, we can destroy
the token and revoke access. With simple username and password access,
the only way to revoke access is to change the password, which means
any place you have saved that password (password managers or other
applications which login via username and password) need to update
their settings as well. With OAuth we can revoke a single token at any
time (and GitHub makes it easy to do this) without affecting access to
other services.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s modify our application to use OAuth.</p>
</div>
<div class="sect3">
<h4 id="_authentication_requires_a_server">Authentication Requires a Server</h4>
<div class="paragraph">
<p>Up until now we have been able to publish all our files into GitHub
and they are hosted for us by GitHub. Sadly the authentication
component cannot be hosted on GitHub. Somehow we need to safely
authenticate our user into GitHub and retrieve an OAuth token. There
is currently no way to do this strictly
client side (using only static HTML and JavaScript running in the
browser). Other authentication providers like Facebook do provide pure
JavaScript login functionality in their SDKs, but GitHub, citing
security concerns, has not released anything that does authentication
purely on the client side as of yet.</p>
</div>
<div class="paragraph">
<p>Somehow we have to involve a server into our authentication process.
The most obvious choice we have is to run a small authentication
server, delegate authentication to it, and once authentication is
completed, jump back in our application hosted on GitHub. We provide
code (written in NodeJS, JavaScript for the server side) to do
this in the associated repository for this chapter. But, creating even
a simple  authentication system has a baseline of complexity that
seems like overkill. If we could instead delegate this authentication
to a third party, we could reduce a massive amount of code and
complexity from our system.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fixing_authentication_with_firebase">Fixing Authentication with Firebase</h4>
<div class="paragraph">
<p>Instead of writing our own server to manage authentication and talk to
the GitHub API, we will delegate that authentication to Firebase. Firebase is a
real time communication toolset which integrates well with our choice
of AngularJS. By far the simplest and safest option,
Firebase offers AngularJS bindings (called "AngularFire") and an
integrated GitHub authentication component (called "Simple Login").
Together they resolve the authentication issue for us, and keep all
our code hosted on GitHub. Delegation of our authentication component is easy with
Firebase: we just modify our existing GitHub application, provide the credentials
and GitHub OAuth scope to Firebase, and then our application offloads
user management to Firebase.</p>
</div>
<div class="paragraph">
<p>First, we need to create a new GitHub application. In the top right
corner on GitHub.com, click on the "Account settings" link, and then
navigate to the "Applications" link towards the bottom. Click on the
"Developer Applications" tab in the right center column and then click on the
"Register new application" button. Make sure "Authorization callback URL" is set to
<code><a href="https://auth.firebase.com/auth/github/callback" class="bare">https://auth.firebase.com/auth/github/callback</a></code>. Then save the
application by clicking on the "Register application" button.</p>
</div>
<div class="paragraph">
<div class="title">A new GitHub application for OAuth</div>
<p>image::images/javascript-new-application.png[A new GitHub application for OAuth</p>
</div>
<div class="paragraph">
<p>Now, create an account on Firebase. Once you have done this, create
a new app called "CoffeeTech" inside Firebase. The APP URL needs be unique, so use
"coffeetech-&lt;USERNAME&gt;", replacing USERNAME with your GitHub username.
Once you have created the app, click on "View Firebase" button. You&#8217;ll
then see a settings screen, and click on "Simple Login" and then
"GitHub."</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-view-firebase.png" alt="Creating the Firebase Hosted Login">
</div>
<div class="title">Figure 7. Creating the Firebase Hosted Login</div>
</div>
<div class="paragraph">
<p>Then, copy your GitHub client ID and secret to the sections inside the
Firebase Simple Login settings for the GitHub provider. Make sure the
"enabled" checkbox is checked to enable the provider.</p>
</div>
<div class="paragraph">
<p>We&#8217;ve now established a login application on GitHub and configured it
to use the Firebase service, and have properly configured Firebase to
use that GitHub application. We want all
functionality, especially external services, to be covered by tests,
so we&#8217;ll write that test coverage next.</p>
</div>
</div>
<div class="sect3">
<h4 id="_testing_firebase">Testing Firebase</h4>
<div class="paragraph">
<p>Since we load firebase from their CDN, we first need to mock out the
<code>Firebase</code> constructor using a simple shim. Put the following into a
file called <code>firebase-mock.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var Firebase = function (url) {
}

angular.module( 'firebase', [] );</code></pre>
</div>
</div>
<div class="paragraph">
<p>To test our code, we make the following changes to our
<code>coffeetech-annotate.spec.js</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">beforeEach( module( "coffeetech" ) );

var mockFirebase = mockSimpleLogin = undefined;
function generateMockFirebaseSupport() { <b class="conum">(1)</b>
    mockFirebase = function() {};
    mockSimpleLogin = function() {
        return {
            '$login': function() {
                return { then: function( cb ) {
                    cb( { name: "someUser",
                          accessToken: "abcdefghi" } );
                } };
            }
        }
    };
}

var $timeout;
beforeEach( inject( function ($controller, $rootScope, $injector ) {
    generateMockRepositorySupport();
    generateMockPrompt();
    generateMockFirebaseSupport(); <b class="conum">(2)</b>
    $timeout = $injector.get( '$timeout' );
    scope = $rootScope.$new();
    ctrl = $controller( "GithubCtrl",
	     { $scope: scope,
	       Github: ghs,
	       '$timeout': $timeout,
	       '$window': prompter,
	       '$firebase': mockFirebase,
	       '$firebaseSimpleLogin': mockSimpleLogin } ); <b class="conum">(3)</b>
} ) );


describe( "#annotate", function() {
    it( "should annotate a shop", function() {
        scope.auth = mockSimpleLogin( mockFirebase() ); <b class="conum">(4)</b>
        scope.city = PORTLAND
        var shop = { name: "A coffeeshop" }
        scope.annotate( shop );
        expect( prompter.prompt.calls.length ).toEqual( 1 ); <b class="conum">(5)</b>
        expect( scope.shopToAnnotate ).toBeTruthy();
        expect( scope.username ).not.toBeFalsy();
        expect( scope.annotation ).not.toBeFalsy();

        expect( repo.fork ).toHaveBeenCalled();
        expect( scope.waiting.state ).toEqual( "forking" );
        $timeout.flush();

        expect( scope.forkedRepo ).toBeTruthy();
        expect( repo.read ).toHaveBeenCalled();
        expect( repo.write ).toHaveBeenCalled();
        expect( repo.createPullRequest ).toHaveBeenCalled();
        expect( scope.waiting.state ).toEqual( "annotated" );
        $timeout.flush();

        expect( scope.waiting ).toBeFalsy();</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We add a <code>generateMockFirebaseSupport()</code> function which creates the mock
firebase and simple login objects.</p>
</li>
<li>
<p>We call this method to initialize the mocks.</p>
</li>
<li>
<p>In our test we use the <code>$controller</code> method
instantiator to inject these mock objects instead of letting AngularJS
inject the real ones. We should modify our other spec file as well now that
we are changing the required injections for any controller.</p>
</li>
<li>
<p>we change our <code>#annotate</code> test and create the auth object
(normally created inside the initialization).</p>
</li>
<li>
<p>We prompt only once for the data to annotate (we don&#8217;t need to
prompt for username and password any longer).</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_firebase_login">Implementing Firebase Login</h4>
<div class="paragraph">
<p>Now, add Firebase support to our AngularJS application. Add the
references to the Firebase support libraries right after AngularJS is loaded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;script src="angular.js"&gt;&lt;/script&gt;
&lt;script src='https://cdn.firebase.com/v0/firebase.js'&gt;&lt;/script&gt;
&lt;script src='https://cdn.firebase.com/libs/angularfire/0.6.0/angularfire.min.js'&gt;&lt;/script&gt;
&lt;script src='https://cdn.firebase.com/js/simple-login/1.2.5/firebase-simple-login.js'&gt;&lt;/script&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to adjust our <code>coffeetech.js</code> file in a few ways. First,
import the firebase into our AngularJS module. Also, our original
Github service expected username and password as parameters, but we now
are using a slightly different signature for oauth tokens.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">var mod = angular.module( 'coffeetech', [ 'firebase' ] );

mod.factory( 'Github', function() {
    return {
        create: function(token) {
            return new Github( { token: token, auth: 'oauth' } );
        }
    };
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we instantiate our controller, we need to inject <code>Firebase</code> and
<code>FirebaseSimpleLogin</code> and initialize them inside our <code>init</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">mod.controller( 'GithubCtrl', [ '$scope', 'Github', 'Geo', '$window', '$timeout',
		'$firebase', '$firebaseSimpleLogin',
		function( $scope, ghs, Geo, $window, $timeout,
			  $firebase, $firebaseSimpleLogin ) {

    $scope.init = function() {

        var ref = new Firebase( 'https://coffeetech.firebaseio.com' );
        $scope.auth = $firebaseSimpleLogin( ref );

        $scope.getCurrentLocation( function( position ) {
            $scope.latitude = position.coords.latitude;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, when we annotate, we need to provide the auth token returned
from Firebase. But, it is gratifying to see that little else needs to
change in our flow.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-javascript" data-lang="javascript">$scope.annotate = function( shop ) {
    $scope.shopToAnnotate = shop;

    $scope.auth.$login( 'github', { scope: 'repo' } ).then( function( user ) { <b class="conum">(1)</b>

        $scope.me = user;
        $scope.username = user.name;

        $scope.annotation = $window.prompt( "Enter data to add" ); <b class="conum">(2)</b>

        if( $scope.annotation ) {
            gh = ghs.create( $scope.me.accessToken ); <b class="conum">(3)</b>
            toFork = gh.getRepo( "xrd", "spa.coffeete.ch" );
            toFork.fork( function( err ) {</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We call the <code>$login</code> method on our auth object created using the
Firebase SimpleLogin service. It returns a "promise" which is an
interface that has a <code>then()</code> method, which will be called if the
<code>$login()</code> succeeds. <code>then()</code> calls our callback function, giving us a
user object.</p>
</li>
<li>
<p>We still need to prompt the user for one piece of information, the
data to annotate. You can imagine other ways to get this information,
using modal HTML5 dialogs, but this will work for us for right now. At
least we are only prompting once instead of three times!</p>
</li>
<li>
<p>Once we are ready to fork we need to create our user object using
the token.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After we make these changes, we can click the "Add factoid" button and
we&#8217;ll get a dialog like this one indicating we are logging into GitHub
(via the Firebase SimpleLogin).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/javascript-firebase-simplelogin.png" alt="The final step in the permission flow for GitHub access using Firebase">
</div>
<div class="title">Figure 8. The final step in the permission flow for GitHub access using Firebase</div>
</div>
<div class="paragraph">
<p>After you authorize the application, the execution flow is identical to the
the prior authentication flow (using username and password). As an optimization
we could check for previous logins before calling <code>$login()</code> again but
we don&#8217;t do that here, meaning the login dialog is momentarily popped up
each time we click the button.</p>
</div>
<div class="paragraph">
<p>Once users have logged in, they will be redirected to the application,
and we&#8217;ll notify them they have submitted a pull request with their
contribution. Since their contribution is associated with their GitHub
account, they will receive standard pull request notifications when
their contribution is accepted, so we don&#8217;t need to implement that
ourselves.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="paragraph">
<p>We&#8217;ve built an application in JavaScript that requires no server and provides users
with a searchable coffeeshop database that accepts contributions in a
very safe and secure way using the Pull Request API. We were able to completely ignore all the
administrative features of a data entry system, delegating all these
to GitHub. Our single page app permits us to focus on one thing:
making a powerful and useful application.</p>
</div>
<div class="paragraph">
<p>In our final chapter we will use CoffeeScript to create our own chat
robot that requests pull request reviews from chat room members
using the Activities API.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2018-10-05 15:35:19 PDT
</div>
</div>
</body>
</html>