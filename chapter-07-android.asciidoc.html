<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.2">
<title>Android and the Git Data API</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove the comments around the @import statement below when using this as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
#map_canvas img,#map_canvas embed,#map_canvas object,.map_canvas img,.map_canvas embed,.map_canvas object{max-width:none!important}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
.antialiased,body{-webkit-font-smoothing:antialiased}
img{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{display:inline-block;color:rgba(0,0,0,.8);font-size:.75em;line-height:1.4;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:-.15em .15em 0 .15em;padding:.2em .6em .2em .5em;vertical-align:middle;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.05em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.spread{width:100%}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1{padding-right:.75em;font-weight:bold}
td.hdlist1,td.hdlist2{vertical-align:top}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none}
span.footnote,span.footnoteref{vertical-align:super;font-size:.875em}
span.footnote a,span.footnoteref a{text-decoration:none}
span.footnote a:active,span.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em;line-height:1.3;font-size:.875em;margin-left:1.2em;text-indent:-1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
h1,h2{letter-spacing:-.01em}
dt,th.tableblock,td.content{text-rendering:optimizeLegibility}
p,td.content{letter-spacing:-.01em}
p strong,td.content strong{letter-spacing:-.005em}
p,blockquote,dt,td.content{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img{page-break-inside:avoid}
thead{display:table-header-group}
img{max-width:100%!important}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
</head>
<body class="article">
<div id="header">
</div>
<div id="content">
<div class="sect1">
<h2 id="_android_and_the_git_data_api">Android and the Git Data API</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You might not use your phone right now as a developer tool, but the
odds are that you will soon. Though there are few tools that allow you to
write code on your mobile device, phones and tablets can be great
tools for reading code. But, we can go beyond the read-only
limitation. The GitHub API is accessible through the well
written EGit client library for Java, and this library supports both reading
data stored on GitHub and writing data back into it. These are a
perfect set of building blocks to develop applications for the Android
platform, currently the world&#8217;s most popular mobile OS.</p>
</div>
<div class="paragraph">
<p>In this chapter, we&#8217;ll use the Java EGit libraries to develop a small
Android application which posts to our blog hosted on GitHub. Our
blogging application will allow us to login to GitHub, and then ask us
for a quick note describing how we are feeling. The application will
then compose a Jekyll blog post for us and push the post into our blog
on GitHub.</p>
</div>
<div class="sect2">
<h3 id="_setting_up">Setting Up</h3>
<div class="paragraph">
<p>To build this application, we need to create a Jekyll blog and then
install the necessary Android build tools.</p>
</div>
<div class="sect3">
<h4 id="_creating_a_jekyll_blog">Creating a Jekyll blog</h4>
<div class="paragraph">
<p>We are writing an application which adds jekyll blog entries, and we
are writing tests to verify our application works as advertisted, so
we need a sandbox blog against which we can run commands. There are
various ways to create a new Jekyll blog. The simplest is to run a
series of Ruby commands documented here; if you want to know more
about Jekyll, it is covered in more depth in the Jekyll chapter.
There are a few items of note when establishing a Jekyll blog that
have some complexity, things like mapping a hostname properly and using the
correct branch inside git. For our purposes here, however, we won&#8217;t need
to make sure all that is established. All we need is to make sure that
we have a sandbox repository that has the structure of a jekyll blog.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ printf "source 'https://rubygems.org'\n\ngem 'github-pages'\ngem 'hub'" &gt;&gt; Gemfile
$ export BLOG_NAME=mytestblog
$ bundle
$ jekyll new $BLOG_NAME
$ cd $BLOG_NAME
$ hub create
$ git push -u origin master</code></pre>
</div>
</div>
<div class="paragraph">
<p>These commands install the correct libraries for using Jekyll (and one
for our tests as well), generate a new blog using the jekyll command
line tool, and then create a blog on GitHub with those files. On the
second line we specify the name of the blog; you are welcome to change
this to any name you&#8217;d like, just make sure the tests match the name.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
When you have finished running these commands, you should close the
terminal window. There are other commands later in this chapter which
should occur in a fresh directory and as such it is best not to run
those commands from within the same directory where you created your
jekyll blog. You&#8217;ve pushed all those files into GitHub, so you could
safely delete the local repository in this directory.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_android_development_tools">Android Development Tools</h3>
<div class="paragraph">
<p>If you don&#8217;t have a physical Android device, don&#8217;t fret. You can follow
along with this chapter without having an actual Android device by doing
development and testing on a virtual device.</p>
</div>
<div class="sect3">
<h4 id="_installing_the_java_sdk">Installing the Java SDK</h4>
<div class="paragraph">
<p>Unfortunately there is no simple shell command to install Java in the
same way as there is for Ruby and NodeJS using RVM or NVM.
Oracle controls the Java language and distribution of official SDKs,
and they restrict access to downloads other than from java.oracle.com.
Java is freely available, but you need to visit java.oracle.com and
find the correct download for your needs. Android works with either
the 1.6 or 1.7 versions of Java.</p>
</div>
</div>
<div class="sect3">
<h4 id="_installing_the_android_sdk">Installing the Android SDK</h4>
<div class="paragraph">
<p>For this application we only need the Android SDK and not the full
bundle of Android Studio. Go to <a href="https://developer.android.com/sdk" class="bare">https://developer.android.com/sdk</a> and
download the appropriate ZIP or TGZ file for your platform. You will
need to establish the proper environment variables so make sure to
follow the README included in the archive.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_avds_for_development">Creating AVDs for Development</h4>
<div class="paragraph">
<p>Once you have installed the Android SDK, you can create a virtual device
called an AVD (Android Virtual Device). To create an AVD, run the
<code>android avd</code> command from a shell prompt. You&#8217;ll see the AVD manager,
and can create new devices and manage existing ones. Mine has multiple
AVDs already created; yours will be empty the first time.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/android-avd.png" alt="The Android Virtual Device (AVD) Manager">
</div>
</div>
<div class="paragraph">
<p>To create a new AVD, click on the "New.." button and follow the
prompts.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/android-new-avd.png" alt="Creating a new Android Virtual Device">
</div>
</div>
<div class="paragraph">
<p>You are generally free to choose whatever settings you like. Google
produces a real device called the Nexus 5. This is the Android
reference device, and is a good option for a generic device with good
support across all features. You can choose this one if you are
confused about which to use.</p>
</div>
<div class="paragraph">
<p>Once you have created an AVD, start it up. It will take a few minutes
to boot; AVDs emulate the chipset in software and
booting up can take a few minutes, unfortunately. There are
alternative tools that speed up AVD boot time (Genymotion is one of
those), but usage of these tools is are outside the scope of this
book. After your AVD has completed booting, you
can test to see if it is correctly started and available using the adb
command line tool.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ adb devices -l
* daemon not running. starting it now on port 5037 *
* daemon started successfully *
List of devices attached
0222fdc60910aede       device usb:1D110000 product:hammerhead model:Nexus_5 device:hammerhead</code></pre>
</div>
</div>
<div class="paragraph">
<p>Running the adb command starts a daemon service which communicates
with your device. In this case the daemon reported that I have a
single device attached via USB which is the emulated Nexus 5 device.</p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_a_new_project">Creating a New Project</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ mkdir ghru # GitHub R U?
$ cd ghru
$ android create project --target android-19 \
--name GHRU --path . \
--activity GitHubRu --package com.githubru</code></pre>
</div>
</div>
<div class="paragraph">
<p>These three commands create a new directory <code>ghru</code>, enter the
directory, and then build a simple Android directory structure with
the proper files.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
You may not have the same installation of Android targets necessary to
run this command. In this case you might get an error like <code>Error:
Target id is not valid. Use 'android list targets' to get the target
ids.</code>. If you receive this error, run the command <code>android list
targets</code> and use a different target. Generally any target beyond
android-19 should work with this code.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you have the ant tool installed, you can build this new project
with the <code>ant debug</code> command. This will create an APK in the bin
directory called <code>./bin/Ghru-debug-unaligned.apk</code>. To install it on
your device run the command <code>ant debug install</code>. Then, you can launch
the application by double clicking on the application titled
"GitHubRu".</p>
</div>
<div class="sect4">
<h5 id="_adding_gradle_support">Adding Gradle support</h5>
<div class="paragraph">
<p>Gradle is a build system for Java and has become the offical build
system for the Android platform. Using a simple <code>build.gradle</code> file we
can build an entire Android application from the command line. Gradle is well supported with more
advanced editors, so you can always import an Android project using
Gradle and use it with editors like Eclipse or Android Studio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:1.0.0-rc2'
    }
}

repositories {
    mavenCentral()
}

apply plugin: 'android'

android {
    compileSdkVersion 19
    buildToolsVersion "19.1"

    sourceSets {  // <b class="conum">(1)</b>
      main {
        manifest.srcFile 'AndroidManifest.xml'
        java.srcDirs = ['src']
        resources.srcDirs = ['src']
        res.srcDirs = ['res']
        assets.srcDirs = ['assets']
      }
    }

}

dependencies {
  compile 'org.eclipse.mylyn.github:org.eclipse.egit.github.core:2.1.5'  // <b class="conum">(2)</b>
   compile( 'commons-codec:commons-codec:1.9' )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Gradle build files use some standard boilerplate which you can ignore
here, but there are two items which are worth noting.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Gradle was not originally designed for Android; it started as a generic java
build tool. We need to specify where the files to compile reside for an android
project using the <code>sourceSets</code> variable.</p>
</li>
<li>
<p>We can install the EGit library, our interface to the GitHub API
from within Java, using this simple declaration. Gradle will download
the proper JAR files from the Maven repository and build them into our
application using this dependency declaration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Recently versions of Android Studio do package gradle, but for this
application you will need to manually install it from gradle.org.</p>
</div>
</div>
<div class="sect4">
<h5 id="_default_android_main">Default Android Main</h5>
<div class="paragraph">
<p>When we use the above commands to create a new android application, it
creates a sample entry point which is the starting point of our
Android application.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.githubru;

import android.app.Activity;
import android.os.Bundle;

public class MainActivity extends Activity
{
    /** Called when the activity is first created. */
    @Override
    public void onCreate(Bundle savedInstanceState)
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the application is launched, the
Android OS will launch this activity and then call the <code>onCreate</code>
method for us. Inside this method, our application calls our parent&#8217;s
implementation of <code>onCreate</code>, and then inflates the layout for our
application. This layout corresponds to an automatically generated XML
file which resides in our layouts directory called <code>main.xml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent"
    &gt;
&lt;TextView
    android:layout_width="fill_parent"
    android:layout_height="wrap_content"
    android:text="Hello World, MainActivity"
    /&gt;
&lt;/LinearLayout&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may have complicated feelings about XML files (I know I do), but
the Android layout XML files are a straightforward way to design
layouts declaratively, and many GUI tools provide sophisticated
ways to manage them. We&#8217;ll manage ours by hand as they are exceedingly
simple.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_preparing_our_application_for_calabash_testing">Preparing our application for Calabash testing</h4>
<div class="paragraph">
<p>Calabash requires the <strong>internet</strong> permission added to your
AndroidManifest.xml file. Calabash is a set of technologies
combined together to permit testing. One of these pieces is a wrapper around
your application (built on Robotium) that communicates with
Ruby over HTTP calls, and as such, your application must permit
network communication. To enable this, edit the <code>AndroidManifest.xml</code>
file to have the internet permission (look for the line labled
<strong>uses-permission</strong>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;manifest xmlns:android="http://schemas.android.com/apk/res/android"
      package="com.whereimat"
      android:versionCode="1"
      android:versionName="1.0"&gt;
    &lt;application android:label="@string/app_name"
                 android:icon="@drawable/ic_launcher"&gt;
      &lt;uses-permission android:name="android.permission.INTERNET" /&gt;
        &lt;activity android:name=".MainActivity"
                  android:label="@string/app_name"&gt;
            &lt;intent-filter&gt;
                &lt;action android:name="android.intent.action.MAIN" /&gt;
                &lt;category android:name="android.intent.category.LAUNCHER" /&gt;
            &lt;/intent-filter&gt;
        &lt;/activity&gt;
    &lt;/application&gt;
&lt;/manifest&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_writing_tests">Writing tests</h4>
<div class="paragraph">
<p>There are many options for writing tests on Java and Android. JUnit is
an option for unit tests, while Robotium provides a way to write user
interface tests. We&#8217;ll use a wrapper around
Robotium called Calabash for Android which allows us to write in a
high level domain specific language. Calabash uses a
simple DSL for writing tests which is readable and elegant. Most
importantly, Calabash scripts are not compiled, so refactoring and
changing tests does not require the code and compile loop involved in
writing tests using pure Java with JUnit.</p>
</div>
<div class="paragraph">
<p>Calabash also has a console mode which allows you to
interactively refine your tests. You jump into a console and query
a running application using simple ruby commands. This is a
powerful way to experiment with the Calabash Ruby API and allows you
to build tests quickly.</p>
</div>
<div class="paragraph">
<p>You already have ruby installed, so to install calabash, run these commands:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ echo "source 'https://rubygems.org'
gem 'calabash-android', '0.4.20'
gem 'httparty'" &gt;&gt; Gemfile
$ bundle install
$ calabash-android gen</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Gemfile</code> you just created should now look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">source 'https://rubygems.org'

gem 'calabash-android', '0.4.20'
gem "httparty"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve also now installed calabash and created the folder structure to hold
our tests along with some helper scripts. The <code>calabash-android gen</code>
command will write out a default calabash feature file. This is
boilerplate which we should change, so make the file named
<code>features/my_first.feature</code> look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">Feature: Login and post

  Scenario: As a valid user I can log into my app and post to my blog
    When I enter the username
    And I enter the password
    And I press button number 1
    Then I wait up to 10 seconds to see "Logged into GitHub"
    Then I choose my blog
    And I enter my current mood status
    And I press button number 1
    Then I wait up to 10 seconds to see "Successful jekyll post"
    And I have a new jekyll post with my mood status</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may not know how this works or what it does behind the scenes, but
the nice thing about Calabash scripts are that they are very readable
by humans without knowing any of those details. This test enters
credentials into the application, presses the first button, then waits
to make sure a login message is displayed, then enters in some text
into a field and presses another button and then expects to see the
text "Successful jekyll post". The last line is an
expectation that we will have created a post inside our GitHub
repository; we will do this using ruby code to pull the file from the
repository and verify it. Whereas the other tests all verify or take
action inside our Android application (like clicking a button), this
line represents a verification happening outside of our
Android application. Calabash allows us to test from whatever vantage
point works best given the situation.</p>
</div>
<div class="paragraph">
<p>When using Calabash, you need to understand two types of files: "feature"
files and "step" files. Feature files define human readable actions
comprising a test. Step files define the code, written in Ruby, behind
these actions. Step files are entirely optional as there are many default steps
defined inside of Calabash that suit many app actions. You can find a
full list of default calabash steps on the
<a href="https://github.com/calabash/calabash-android/blob/master/ruby-gem/lib/calabash-android/canned_steps.md">Canned
Steps</a> page. Though you are not required to write steps and can often
avoid writing ruby code entirely when writing calabash tests for Android applications,
steps files are very useful when you want to refactor a long
set of actions into a smaller piece and reuse it, or when you need to
do something in Ruby that is not possible in a meta DSL (domain
specific language) like Calabash. For example, in this case we will be
using username and passwords retrieved from our environment rather
than storing them inside our source files. Keeping passwords inside
our source repositories is never a good idea.</p>
</div>
<div class="paragraph">
<p>Gradle and the Gradle Android plugin establish several useful "tasks" for you,
one of which is <code>assembleRelease</code>. That task builds a release version of your
application for you. We need to then resign the APK (the Android
application package format), and then we specify the <code>run</code> subtask
with a path to the APK to run our tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ gradle assembleDebug
$ bundle exec calabash-android resign build/apk/ghru-release-unsigned.apk
$ bundle exec calabash-android run build/apk/ghru-release-unsigned.apk</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have not yet built the code to make these tests pass, and in addition,
we have not yet implemented the step definitions for our feature
tests. So, we see calabash provide us with boilerplate code which we
will copy into our step definition files to complete the test suite.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/android-calabash-failures.png" alt="Calabash reports not-yet-implemented steps">
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
You can run calabash using just the abbreviated <code>calabash-android</code> command instead of <code>bundle
exec calabash-android</code>. But, there are good reasons to use the full
command. Adding bundle exec means that you are running your commands
within the bundler context, loading the gems which you specified in
the Gemfile. If you don&#8217;t use this prefix, things might work, or they
might not. At the time of this writing, there was a bug with the
newest version of Calabash for Android (0.4.21). To rectify this, we
specify 0.4.20 in our Gemfile. If we run without <code>bundle exec</code> then we
will not load the correct version of the calabash gems if another
newer version of calabash was previously installed (as it was in my
case). You&#8217;ll see this if you run <code>calabash-android version</code> even once
you&#8217;ve bundled with an older version.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Copy and paste the output from our initial run into the file
<code>features/step_definitions/calabash_steps.rb</code>. This is our starting
point, with pending indicated for the places we will be adding our
code. Once the boilerplate is pasted in, modify it to enter
text into several Android text widgets. These ruby commands for
calabash are available in the
<a href="https://github.com/calabash/calabash-android/blob/master/documentation/ruby_api.md">Ruby API document</a></p>
</div>
<div class="paragraph">
<p>Let&#8217;s write some Ruby code to back our feature file. We&#8217;ll start by
writing some support functions: <code>set_title_and_mood</code> (a function to
randomly generate a title and mood) and <code>check_and_set</code> (a generic
function to enter data into a text field designated by an ID).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-ruby" data-lang="ruby">require 'calabash-android/calabash_steps'
require 'httparty'

def set_title_and_mood
  moods = %w{ happy sad angry blue energized } # <b class="conum">(1)</b>
  @mood = "Feeling #{moods[(rand()*moods.length).to_i]} today" # <b class="conum">(2)</b>
  @title = @mood.downcase.strip.gsub(' ', '-').gsub(/[^\w-]/, '') # <b class="conum">(3)</b>
  date = (ENV['date'] ? Time.parse(ENV['date']) : Time.now).strftime('%Y-%m-%d') # <b class="conum">(4)</b>
  @filename = "_posts/#{date}-#{@title}.md" # <b class="conum">(5)</b>
end

def check_and_set( id, text )
  check_element_exists "edittext id:'#{id}'" # <b class="conum">(6)</b>
  query "edittext id:'#{id}'", :setText =&gt; text
end</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Create an array of moods.</p>
</li>
<li>
<p>Randomly choose one of the moods to build a string stating our mood.</p>
</li>
<li>
<p>Convert the mood string into a title suitable for a Jekyll post.</p>
</li>
<li>
<p>If we want to inject a date manually, retrieve it from the
environment, otherwise, get the current date. Then format it according
to the Jekyll conventions for post filenames.</p>
</li>
<li>
<p>Use the mood and date to build the complete Jekyll post filename.</p>
</li>
<li>
<p>Use the calabash ruby API to find an element given an ID passed as
a parameter, and then set the text for that element using the second parameter.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Then we run from the command line using this command <code>GH_USER=foobar
GH_PASS=barfoo GH_REPO=mytestblog calabash-android run
build/apk/ghru-release-unsigned.apk</code>. Our tests will still fail to pass,
but now we are establishing a baseline success story for the
real functionality of our future app.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/android-calabash-failures2.png" alt="Calabash failures show us what features we need to complete">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_implementing_the_login_screen">Implementing the Login Screen</h4>
<div class="paragraph">
<p>So, let&#8217;s start building our application. Obviously we need to put a
username and password field into our application. Jumping into our XML
layout files and editing gives us this file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent"
    &gt;
&lt;TextView
    android:layout_width="fill_parent"
    android:layout_height="wrap_content"
    android:text="GitHub Username:"
    /&gt;
&lt;EditText
    android:layout_width="fill_parent"
    android:layout_height="wrap_content"
    android:id="@+id/username"
    /&gt;

&lt;TextView
    android:layout_width="fill_parent"
    android:layout_height="wrap_content"
    android:text="GitHub Password:"
    /&gt;

&lt;EditText
    android:layout_width="fill_parent"
    android:layout_height="wrap_content"
    android:id="@+id/password"
    /&gt;

&lt;Button
    android:layout_width="fill_parent"
    android:layout_height="wrap_content"
    android:text="Login"
    android:id="@+id/login"
    /&gt;

&lt;TextView
    android:layout_width="fill_parent"
    android:layout_height="wrap_content"
    android:text="GitHub Password:"
    android:id="@+id/login_status"
    /&gt;

&lt;/LinearLayout&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This XML builds our interface: input fields for the username and
password (each accompanied by a description), a button to login, and a
status field to indicate success or failure. This is our entry screen.</p>
</div>
<div class="paragraph">
<p>We also need a layout once we have logged in. Create a file called
<code>logged_in.xml</code> inside the <code>res/layout</code> directory. Once logged in,
the user is presented with a layout asking them to choose which
repository to save into, asks them to enter their blog post
into a large text field and then click a button to submit
that blog post. We also leave an empty status box beneath the button to
provide context while saving the post.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:orientation="vertical"
    android:layout_width="fill_parent"
    android:layout_height="fill_parent"
    &gt;
  &lt;TextView
      android:layout_width="fill_parent"
      android:layout_height="wrap_content"
      android:text="Logged into GitHub"
      android:layout_weight="0"
      /&gt;

  &lt;EditText
      android:layout_width="fill_parent"
      android:layout_height="wrap_content"
      android:hint="Enter the blog repository"
      android:id="@+id/repository"
      android:layout_weight="0"
      /&gt;

  &lt;EditText
      android:gravity="top"
      android:layout_width="fill_parent"
      android:layout_height="fill_parent"
      android:hint="Enter your blog post"
      android:id="@+id/post"
      android:layout_weight="1"
      /&gt;

  &lt;Button
      android:layout_width="fill_parent"
      android:layout_height="wrap_content"
      android:layout_weight="0"
      android:id="@+id/submit"
      android:text="Send blog post"/&gt;

  &lt;TextView
      android:layout_width="fill_parent"
      android:layout_height="wrap_content"
      android:id="@+id/post_status"
      android:layout_weight="0"
      android:text=""/&gt;

&lt;/LinearLayout&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our <code>MainActivity</code> now can implement the functionality to use these
two layouts.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.githubru;

import android.app.Activity;
import android.os.Bundle;
import android.widget.Button;
import android.widget.LinearLayout;
import android.widget.EditText;
import android.widget.TextView;
import android.view.View;

public class MainActivity extends Activity
{
    /** Called when the activity is first created. */
    @Override
    public void onCreate(Bundle savedInstanceState)
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);

        Button login = (Button)findViewById( R.id.login ); <b class="conum">(1)</b>
        login.setOnClickListener(new View.OnClickListener() {
                public void onClick(View v) {
                    login(); <b class="conum">(2)</b>
                }
            });
    }

    private void login() {

        setContentView(R.layout.logged_in); <b class="conum">(3)</b>

        Button submit = (Button)findViewById( R.id.submit );
        submit.setOnClickListener(new View.OnClickListener() {
                public void onClick(View v) {
                    doPost(); <b class="conum">(4)</b>
                }
            });
    }

    private void doPost() {
        TextView tv = (TextView)findViewById( R.id.status ); <b class="conum">(5)</b>
        tv.setText( "Successful jekyll post" );
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code mocks out the functionality we will be building and shows us
exactly what the UI will look like once that code is completed.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We register a click handler for our login button.</p>
</li>
<li>
<p>When the login button is clicked, we call the <code>login()</code> function</p>
</li>
<li>
<p>Once we have logged in, we setup a new layout with UI elements suitable for making a blog post</p>
</li>
<li>
<p>We then setup another click handler for the submit button; when
clicked, we call the <code>doPost()</code> function.</p>
</li>
<li>
<p>Our <code>doPost()</code> function updates the status message at the bottom
of our application.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Even though our code is not functional yet, this application will
compile. This is a good time to play with this application and verify
the UI looks appropriate. Were we to click the
login button, we would see that our blog post form looks like this.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/android-calabash-logged-in.png" alt="A simple UI for making blog post entries">
</div>
</div>
<div class="paragraph">
<p>Our tests will pass completely right now except for the final
test which checks GitHub to verify a file was correctly posted. We can
now proceed to writing code to login to GitHub and write a file into
our Jekyll repository.</p>
</div>
</div>
<div class="sect3">
<h4 id="_code_to_login_to_github">Code to Login to GitHub</h4>
<div class="paragraph">
<p>Let&#8217;s first work on the <code>login()</code> method. Poking into the
<a href="https://github.com/eclipse/egit-github/tree/master/org.eclipse.egit.github.core">EGit
libary reference</a>, we can write GitHub login code that is as simple as
the following.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">//Basic authentication
GitHubClient client = new GitHubClient();
client.setCredentials("user", "passw0rd");</code></pre>
</div>
</div>
<div class="paragraph">
<p>The context in which the code runs makes as much a difference as the
code. The Android OS disallows any code from making network
connections unless it runs inside a background thread.
If your eyes are starting to spin at the thought of learning about
threading using Java, dispell your worries. The Android SDK provides a
great class for managing background thread code called <code>AsyncTask</code>. We
implement a class which supports this interface by overriding at least one method
which runs our background thread code (called <code>doInBackground()</code>).</p>
</div>
<div class="paragraph">
<p>Before we implement the login, we need to update our <code>onCreate</code>
function to register a click  handler that will call the login task we
will define.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We retrieve the username and password from our UI elements.</p>
</li>
<li>
<p>Our UI should notify the user that a login is occurring in a
background task, so we grab the status text element and update the text in it.</p>
</li>
<li>
<p>We then start the background thread process to do our login. This
syntax creates a new thread for us with the username and password as
parameters. Android will manage the lifecycle of this thread for us,
including starting the new thread separate from the main UI thread.</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    @Override
    public void onCreate(Bundle savedInstanceState)
    {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.main);

        Button login = (Button)findViewById( R.id.login );
        login.setOnClickListener(new View.OnClickListener() {
                public void onClick(View v) {
                    EditText utv = (EditText)findViewById( R.id.username );
                    EditText ptv = (EditText)findViewById( R.id.password );
                    username = (String)utv.getText().toString();
                    password = (String)ptv.getText().toString(); // <b class="conum">(1)</b>
                    TextView status = (TextView)findViewById( R.id.login_status );
                    status.setText( "Logging in, please wait..." ); // <b class="conum">(2)</b>
                    new LoginTask().execute( username, password );  // <b class="conum">(3)</b>
                }
            });
    }
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can implement <code>LoginTask</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    class LoginTask extends AsyncTask&lt;String, Void, Boolean&gt; {   // <b class="conum">(1)</b>
        @Override
            protected Boolean doInBackground(String... credentials) { // <b class="conum">(2)</b>
            boolean rv = false;
            UserService us = new UserService();
            us.getClient().setCredentials( credentials[0], credentials[1] );
            try {
                User user = us.getUser( credentials[0] );  // <b class="conum">(3)</b>
                rv = null != user;
            }
            catch( IOException ioe ) {}
            return rv;
        }

        @Override
            protected void onPostExecute(Boolean result) {
            if( result ) {
                loggedIn();  // <b class="conum">(4)</b>
            }
            else { // <b class="conum">(5)</b>
                TextView status = (TextView)findViewById( R.id.login_status );
                status.setText( "Invalid login, please check credentials" );
            }
        }
    }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Here we define the derived AsyncTask class. The three types in the
generics signature provide a way to parameterize our instantiated task;
we need to provide a username and password to the background task, and
the first type in the signature allows us to pass an array of Strings.
You can see in the actual method definition that the ellipsis notation
provides a way to parameterize a method with a variable number of
arguments (called varargs). Inside our defined method we expect we
will send two Strings in, and we make sure to do that in our call.</p>
</li>
<li>
<p>Once inside the <code>doInBackground()</code> function, we instantiate a
<code>UserService</code> class, a wrapper around the GitHub API which interacts
with the user service API call. In order to access this information,
we have to retrieve the client for this service call and provide the
client with the username and password credentials. This is the syntax
to do that.</p>
</li>
<li>
<p>We wrap the call to <code>getUser()</code> in a try block as the function
signature can throw an error (if the network were down, for example).
We don&#8217;t really need to retrieve information about the user using the
User object, but this call verifies that our username and password are
correct and we store the result of the call in our return value.
GitHub will not use the credentials you set until you make an API
call, so we need to use our credentials to access something in order
to verify those credentials work.</p>
</li>
<li>
<p>We renamed the <code>login()</code> function to more accurately reflect the
fact that when we call this, we are already logged into GitHub.</p>
</li>
<li>
<p>If our login was a failure, either because of network failure, or
because our credentials were incorrect, we indicate this in the status
message. A user can retry if they wish.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><code>loggedIn</code> updates the UI once logging in has completed and then makes
the post on GitHub. Once again, we will need to implement <code>doPost</code> in an
asynchronous task since it makes network connections.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    private void loggedIn() {

        setContentView(R.layout.logged_in);  // <b class="conum">(1)</b>

        Button submit = (Button)findViewById( R.id.submit );
        submit.setOnClickListener(new View.OnClickListener() {
                public void onClick(View v) {
                    doPost();  // <b class="conum">(2)</b>
                }
            });
    }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Change the UI to reflect the fact we are now logged in.</p>
</li>
<li>
<p>If we click on the button, make the post to the server.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Building out <code>doPost</code> should be more familiar now that we have
experience with AsynchronousTasks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    private void doPost() {
        new PostTask().execute( username, password );
    }

    class PostTask extends AsyncTask&lt;String, Void, Boolean&gt; {

        @Override
        protected Boolean doInBackground(String... credentials) {
            String login = credentials[0];
            String password = credentials[1];

            EditText post = (EditText)findViewById( R.id.post );
            String postContents = post.getText().toString();

            EditText repo = (EditText)findViewById( R.id.repository );
            String repoName = repo.getText().toString();

            GitHubHelper ghh = new GitHubHelper( login, password ); // <b class="conum">(1)</b>
            return ghh.SaveFile( repoName, postContents );
        }

        @Override
        protected void onPostExecute(Boolean result) {
            TextView status = (TextView)findViewById( R.id.post_status );
            if( result ) {
                status.setText( "Successful jekyll post" );
            }
            else {
                status.setText( "Post failed." );
            }
        }
    }
...</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We will create a helper class that will wrap our interactions with
GitHub. We&#8217;ll call it <code>GitHubHelper</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We need to import the support
classes. The JARs and classes for EGit have already been added to our project
automatically using gradle. Make sure you add these <code>import</code>
statements to the top of the file, under the other imports.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
import android.view.View;
import android.os.AsyncTask;
import org.eclipse.egit.github.core.service.UserService;
import org.eclipse.egit.github.core.User;
import java.io.IOException;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we are ready to write the code to write data into GitHub.</p>
</div>
</div>
<div class="sect3">
<h4 id="_code_to_talk_to_github">Code to talk to GitHub</h4>
<div class="paragraph">
<p>Our last step is to write the code which handles putting content into GitHub.
This is not a simple function, because the GitHub API requires you
build out the structure used internally by Git. A great reference for learning more about
this structure is the free and open source book called "Pro Git" and
specifically the last chapter called "Git Internals":http://git-scm.com/book/en/Git-Internals. In a nutshell, the GitHub
API expects you to create a git "tree" and then place a "blob" object
into that tree. You then wrap the tree in a "commit" object and then
create that commit on GitHub using a data service wrapper. In
addition, writing a tree into GitHub requires knowing the base SHA
identifier, so you&#8217;ll see code which retrieves the last SHA in the
tree associated with our current branch. This code will work
regardless of whether we are pushing code into the master branch, or
into the gh-pages branch, so this utility class works with real
Jekyll blogs. It would be lovely if the GitHub API provided more
"porcelain" (the Git term for user friendly verbs that insulate you
from knowing the internals of Git) instead of only this "plumbing" API.
Having the API work like this does give you full control over your
repository and gives you the same power you would have with a local
repository.</p>
</div>
<div class="paragraph">
<p>We&#8217;ll write a helper class called <code>GitHubHelper</code> and add a single
method which writes a file to our repository.</p>
</div>
<div class="paragraph">
<p>The GitHub API requires that files written into repositories be
Base64 encoded. The Apache Foundation provides a suite of tools
published to Maven (the same software repository where we grabbed the
EGit libraries) which can do this encoding for us. To add this library
to our project, we need to add to our dependencies inside our <code>build.gradle</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...

dependencies {
  compile 'org.eclipse.mylyn.github:org.eclipse.egit.github.core:2.1.5'
   compile( 'commons-codec:commons-codec:1.9' )
}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our new helper class is verbose but at least provides a simple wrapper
around the complicated GitHub API for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package com.githubru;

import org.eclipse.egit.github.core.*;
import org.eclipse.egit.github.core.service.CommitService;
import org.eclipse.egit.github.core.service.DataService;
import org.eclipse.egit.github.core.service.GistService;
import org.eclipse.egit.github.core.service.RepositoryService;
import org.apache.commons.codec.binary.Base64;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.io.IOException;
import java.util.*;

class GitHubHelper {

    String login;
    String password;

    GitHubHelper( String _login, String _password ) {
        login = _login;
        password = _password;
    }

    public boolean SaveFile( String _repoName, String _post ) {
        post = _post;
        repoName = _repoName;

        boolean rv = false;

        try {
            generateContent();
            createServices();
            retrieveBaseSha();
            createBlob();
	    generateTree();
            createCommit();
            createResource();
            updateMasterResource();
            rv = true;
        }
        catch( IOException ieo ) {
            ieo.printStackTrace();
        }

        return rv;
    }


    String blobSha;
    Tree newTree;
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code uses several top level functions to present the steps we
need to use to write data into a remote GitHub repository. We start by
providing a constructor with our login and password. Then, we
implement a method called SaveFile which takes the repository name and
the post contents. From here, we work to build the proper structure
for creating a new Jekyll post.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s implement each of the functions specified in the
GitHubHelper class.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_writing_the_blog_content">Writing the blog content</h3>
<div class="paragraph">
<p>First, we implement <code>generateContent()</code>. The following code snippet
shows functions defined to generate the content which we will place
into our remote git repository stored on GitHub.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...

    String blobSha; <b class="conum">(1)</b>
    Tree newTree;
    String commitMessage;
    String postContentsWithYfm;
    String contentsBase64;
    String filename;
    String post;
    String repoName;

    private void generateContent() { <b class="conum">(2)</b>
        commitMessage = "GitHubRu Update";
        postContentsWithYfm = "---\nlayout: post\npublished: true\n---\n\n" + post;  <b class="conum">(3)</b>
        contentsBase64 = new String( Base64.encodeBase64( postContentsWithYfm.getBytes() ) );  <b class="conum">(4)</b>
        getFilename( post );
    }

    private void getFilename( String post ) {
        String title = post.substring( 0, post.length() &gt; 30 ? 30 : post.length() ); <b class="conum">(5)</b>
        String jekyllfied = title.toLowerCase().replaceAll( "\W+", "-").replaceAll( "\W+$", "" ); <b class="conum">(6)</b>
        SimpleDateFormat sdf = new SimpleDateFormat( "yyyy-MM-dd-" );
        String prefix = sdf.format( new Date() ); <b class="conum">(7)</b>
        filename = "_posts/" + prefix + jekyllfied + ".md"; <b class="conum">(8)</b>
    }
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will notice many similarities between this Java code and the
Ruby code we used in the Jekyll chapter when generating filenames
and escaping whitespace.</p>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We define several instance variables which store data we will use
later in method calls; data like the SHA hash for our blob, the tree
into which we will place our commit, and strings which are used when
creating the commit. Though not typical of most Java class definitions
which place all member variables at the top of the class,
placing them right above the methods which load data into them makes
it easier to explain their relevance, so we do that for all variables
used in the following methods.</p>
</li>
<li>
<p>Our method generateContent sets a commit message.</p>
</li>
<li>
<p>Creates the YAML Front Matter (see the <a href="#Jekyll">[Jekyll]</a> chapter for more
details on YFM). This YAML specifies the "post" layout and sets
publishing to "true". We need to terminate the YAML with two newlines.</p>
</li>
<li>
<p>base64 encode the contents of the blog post
itself using a utility class found inside the Apache Commons
library. Contents inside a git repository are stored either as UTF-8
content or base64; we could have used UTF-8 since this is text content
but base64 works losslessly and you can always safely use base64
without concerning yourself about the content.</p>
</li>
<li>
<p>Next, define the getFilename() method; use the first 30 characters
of the post to generate the title.</p>
</li>
<li>
<p>Convert the title to lowercase, and replace whitespace with
hyphens to get the Jekyll post title format.</p>
</li>
<li>
<p>Format a date as Jekyll expects.</p>
</li>
<li>
<p>Create the full filename.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_services">Services</h3>
<div class="paragraph">
<p>Next, we implement <code>createServices()</code>. There are several services
(wrappers around git protocols) which we need to instantiate. We don&#8217;t
use them all immediately, but we will need them at various steps
during the file save process. The <code>createServices</code> call manages these
for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...

    RepositoryService repositoryService;
    CommitService commitService;
    DataService dataService;

    private void createServices() throws IOException {
        repositoryService = new RepositoryService();
        repositoryService.getClient().setCredentials( login, password );
        commitService = new CommitService();
        commitService.getClient().setCredentials( login, password );
        dataService = new DataService();
        dataService.getClient().setCredentials( login, password );
    }

...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_base_sha_from_the_repository_and_branch">The Base SHA from the Repository and Branch</h3>
<div class="paragraph">
<p>Now we implement <code>retrieveBaseSha()</code>. A git repository is a directed acrylic graph (DAG) and as such, each
node in the graph must have a starting point. When we append content
to our graph, we need to determine the starting point on that
graph. <code>retrieveBaseSha</code> does this: it finds the SHA hash for our
starting point, a SHA hash which is functionally an address inside our
tree. To determine this address, our applications needs to have a reference to the
repository, and we use the repository service we instantiated
earlier to get this reference. Once we have the repository, we need to look inside the
correct branch: <code>getBranch</code> does this for us.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...

    Repository repository;
    RepositoryBranch theBranch;
    String baseCommitSha;
    private String retrieveBaseSha() throws IOException {
        // get some sha's from current state in git
        repository =  repositoryService.getRepository(login, repoName);
        theBranch = getBranch();
        return theBranch.getCommit().getSha();
    }

    public RepositoryBranch getBranch() throws IOException {
	List&lt;RepositoryBranch&gt; branches = repositoryService.getBranches(repository);
	RepositoryBranch master = null;
	// Iterate over the branches and find gh-pages or master
	for( RepositoryBranch i : branches ) {
	    String theName = i.getName().toString();
	    if( theName.equalsIgnoreCase("gh-pages") ) {
		theBranch = i;
	    }
	    else if( theName.equalsIgnoreCase("master") ) {
		master = i;
	    }
	}
	if( null == theBranch ) {
	    theBranch = master;
	}
	return theBranch;
    }

...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_blob">Creating the Blob</h3>
<div class="paragraph">
<p>Contents inside a git repository are stored as blobs. <code>createBlob</code>
manages storing our content as a blob object, and then uses the
dataService to store this blob into a repository. Until we have called
<code>dataService.createBlob</code>, we have not actually placed the object
inside GitHub. Also, remember that blobs are not linked into our DAG
by themselves; they need to be associated with our DAG vis-a-vis a
tree and commit object, which we do next.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...

    Blob blob;
    Tree baseTree;
    private void createBlob() throws IOException {
	Random random = new Random();
	blob = new Blob();
	blob.setContent(contentsBase64);
	blob.setEncoding(Blob.ENCODING_BASE64);
	dataService.createBlob(repository, blob);
    }

...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_generating_a_tree">Generating a Tree</h3>
<div class="paragraph">
<p>Next, we generate a tree by implementing <code>generateTree()</code>. A tree
wraps a blob object and provides basically a path to our object:
you can think of a tree as the filename path and the blob as an inode
object. Our data service manager uses a repository name and a base SHA
address, one that we retrieved earlier, to validate that this is a
valid starting point inside our repository. Once we have a tree, we
fill out the necessary tree attributes, like tree type (blob) and and
tree mode (blob), and set the SHA from the previously created blob
object along with the size. Then we store the tree into our GitHub
account using the data service object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    Tree baseTree;
    private void generateTree() throws IOException {
        baseTree = dataService.getTree(repository, baseCommitSha);
	TreeEntry treeEntry = new TreeEntry();
	treeEntry.setPath( filename );
	treeEntry.setMode( TreeEntry.MODE_BLOB );
	treeEntry.setType( TreeEntry.TYPE_BLOB );
	treeEntry.setSha(blobSha);
	treeEntry.setSize(blob.getContent().length());
	Collection&lt;TreeEntry&gt; entries = new ArrayList&lt;TreeEntry&gt;();
	entries.add(treeEntry);
	newTree = dataService.createTree( repository, entries, baseTree.getSha() );
    }

...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_commit">Creating the Commit</h3>
<div class="paragraph">
<p>We are getting close to actually finalizing the creation of content:
next, implement <code>createCommit()</code>. We have created
a blob which stores the actual content, and created a tree which
stores the path to the content (more or less), but since git is a
version control system, we also need to store information about who
wrote this object and why. A commit object stores this
information. The process should look familiar coming from the previous
steps: we create the commit and then add relevant metadata, in this case the
commit message. The "who" of this commit is inferred from our login:
GitHub knows that we authenticated and assigns this commit to us on
the server side. We then use the data service to create the commit
inside our repository in GitHub at the correct SHA address.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    Commit newCommit;
    private void createCommit() throws IOException {
        // create commit
        Commit commit = new Commit();
        commit.setMessage( commitMessage );
        commit.setTree( newTree );
        List&lt;Commit&gt; listOfCommits = new ArrayList&lt;Commit&gt;();
        listOfCommits.add(new Commit().setSha(baseCommitSha));
        commit.setParents(listOfCommits);
        newCommit = dataService.createCommit(repository, commit);
    }

...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_the_resource_and_updating_the_master">Creating the Resource and Updating the Master</h3>
<div class="paragraph">
<p>Finally, we create <code>updateMasterResource()</code>. We need to adjust
"master" or "gh-pages", the branch from which GitHub will generate
your Jekyll blog. Previously, we determined the correct branch against which to apply our additions. GitHub
follows this convention when generating your Jekyll blog, using either
master or gh-pages as the checkout point for retrieving your content
and then doing a site rebuild from a working copy there. In our code,
we use the commit we created and stored in the previous code to
generate a commit resource, set the URL, and then use our data service
to update the reference inside the repository inside GitHub.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    TypedResource commitResource;
    private void createResource() {
        commitResource = new TypedResource();
        commitResource.setSha(newCommit.getSha());
        commitResource.setType(TypedResource.TYPE_COMMIT);
        commitResource.setUrl(newCommit.getUrl());
    }

    private void updateMasterResource() throws IOException {
        // get master reference and update it
        Reference reference = dataService.getReference(repository, "heads/" + theBranch.getName() );
        reference.setObject(commitResource);
        Reference response = dataService.editReference(repository, reference, true) ;
    }

...</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_our_final_dopost">Implementing Our Final doPost</h3>
<div class="paragraph">
<p>Finally, we can now implement the <code>doPost()</code> method inside our
<code>MainActivity</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">...
    private void doPost() {
        new PostTask().execute( username, password );
    }

    class PostTask extends AsyncTask&lt;String, Void, Boolean&gt; {

        @Override
            protected Boolean doInBackground(String... credentials) {
            String login = credentials[0];
            String password = credentials[1];

            EditText post = (EditText)findViewById( R.id.post );
            String postContents = post.getText().toString();

            EditText repo = (EditText)findViewById( R.id.repository );
            String repoName = repo.getText().toString();

            GitHubHelper ghh = new GitHubHelper( login, password );
            return ghh.SaveFile( repoName, postContents );
        }

        @Override
            protected void onPostExecute(Boolean result) {
            TextView status = (TextView)findViewById( R.id.post_status );
            if( result ) {
                status.setText( "Successful jekyll post" );
            }
            else {
                status.setText( "Post failed." );
            }
        }
    }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Our <code>doPost()</code> command now does one thing: instantiates a new
PostTask. As we are performing network operations, we again create a
subclass of <code>AsyncTask</code> which handles these operations automatically
on a background thread. We pass in the username and password which we
retrieved earlier along with the post contents and the repository name
we specified. We&#8217;ve isolated our GitHub code into our helper class;
our MainActivity class does only the necessary steps to retrieve items
from UI elements and pass them on to our helper class.</p>
</div>
<div class="sect3">
<h4 id="_passing_our_tests">Passing our Tests</h4>
<div class="paragraph">
<p>Now that we have fully implemented our Android application, we can run
our tests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ GH_REPO=mytestblog \
GH_USERNAME=myusername \
GH_PASSWORD=mypassword \
bundle exec \
calabash-android run build/apk/ghru-release-unsigned.apk</code></pre>
</div>
</div>
<div class="paragraph">
<p>You&#8217;ll see them pass with flying colors this time:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/android-calabash-success.png" alt="A successful end-to-end test of our Android application">
</div>
</div>
<div class="paragraph">
<p>If you want to see a more complicated version of the GitHub API on
Android, take a look at <a href="https://github.com/xrd/TeddyHyde.git">Teddy
Hyde</a> (also available on the Google Play Store). Teddy Hyde is the "the extensible,
one handed GitHub editor for Android." A few years ago I was searching
for a way to publish Jekyll blogs into GitHub while my infant son
slept on my chest. It is hard to type on a computer with a baby in one
arm, and when I couldn&#8217;t find a Jekyll editor for Android, I decided
to write one myself.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_summary">Summary</h3>
<div class="paragraph">
<p>This application will allow you to write into a real Jekyll blog,
adding posts, upon which GitHub will regenerate your site. This little
application manages quite a few things: formatting the filename
correctly, encoding the data for submission to GitHub, and we have a
user interface test which verifies the functionality. We even
demonstrate how to write user interface tests which verify that the
result of a GitHub API call is proper handled on the server side.</p>
</div>
<div class="paragraph">
<p>In the next chapter we will look at building a single page application
that edits information inside a GitHub repository using JavaScript and
the GitHub.js library talking to the Pull Request API.</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2015-10-01 08:12:29 PDT
</div>
</div>
</body>
<script type="text/javascript" src="init.js"></script>

</html>